<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุธุงู ุงูุชุณุนูุฑ - ุดุฑูุฉ ุนูู ููุฏ ูุณุนูุฏ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #C89F65;
            --secondary: #D4AF6E;
            --dark: #2C3338;
            --darker: #1F2327;
            --card: #3A4048;
            --accent: #F4B942;
            --border: #4A5058;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, var(--darker), var(--dark));
            color: #E8E8E8;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        header {
            background: var(--card);
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 2px solid var(--primary);
            text-align: center;
        }
        h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .subtitle { color: var(--secondary); font-size: 1.2em; }
        .admin-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--darker);
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(200,159,101,0.4);
        }
        .admin-btn:hover { transform: translateY(-3px); }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--card);
            padding: 40px;
            border-radius: 20px;
            border: 2px solid var(--primary);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .tab {
            flex: 1;
            min-width: 150px;
            padding: 18px 20px;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.95em;
        }
        .tab:hover { border-color: var(--primary); transform: translateY(-2px); }
        .tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--darker);
            border-color: var(--accent);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card {
            background: var(--card);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
        }
        .card-header {
            font-size: 1.8em;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        label {
            color: var(--secondary);
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.95em;
        }
        input, select, textarea {
            padding: 14px;
            background: var(--darker);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: white;
            font-size: 1em;
            font-family: 'Cairo', sans-serif;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        button {
            padding: 16px 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--darker);
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Cairo', sans-serif;
        }
        button:hover { transform: translateY(-3px); }
        button.secondary {
            background: var(--dark);
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        .section-title {
            color: var(--primary);
            font-size: 1.3em;
            margin: 25px 0 15px;
            padding-right: 15px;
            border-right: 4px solid var(--primary);
        }
        .result-box {
            background: linear-gradient(135deg, rgba(200,159,101,0.15), rgba(212,175,110,0.15));
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
            border: 2px solid var(--primary);
        }
        .result-title {
            color: var(--accent);
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 15px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .stat {
            background: var(--darker);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        .stat-label {
            color: #B8B8B8;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        .stat-value {
            color: var(--primary);
            font-size: 1.6em;
            font-weight: 700;
        }
        .hours-adjust {
            background: var(--darker);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid var(--accent);
        }
        .hours-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
        }
        .hours-row label { flex: 1; margin: 0; }
        .hours-row input { flex: 2; }
        .hours-row .suggested {
            flex: 1;
            color: var(--accent);
            font-size: 0.9em;
        }
        .hidden { display: none !important; }
        .admin-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--primary);
            color: var(--darker);
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 700;
            z-index: 1000;
        }
        .comparison-table {
            width: 100%;
            margin-top: 20px;
        }
        .comparison-table td {
            padding: 15px;
            border: 1px solid var(--border);
        }
        .comparison-table tr:first-child td {
            background: var(--primary);
            color: var(--darker);
            font-weight: 700;
        }
        .increase { color: #FF6B6B; }
        .decrease { color: #51CF66; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--darker);
            border-radius: 10px;
            overflow: hidden;
        }
        th {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--darker);
            padding: 15px;
            text-align: right;
            font-weight: 700;
        }
        td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            color: #E8E8E8;
        }
        tr:hover { background: var(--card); }
        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            .form-grid { grid-template-columns: 1fr; }
            .tabs { flex-direction: column; }
            .tab { min-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>โ๏ธ ูุธุงู ุชุณุนูุฑ ุงููุฑุงุฌุนุฉ โ๏ธ</h1>
            <p class="subtitle">ุดุฑูุฉ ุนูู ููุฏ ูุณุนูุฏ ูุญุงุณุจูู ููุฑุงุฌุนูู ูุงูููููู</p>
        </header>

        <!-- Admin Modal -->
        <div id="authModal" class="modal">
            <div class="modal-content">
                <h2 class="card-header">ุฏุฎูู ุงููุฏูุฑ</h2>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>ุงุณู ุงููุณุชุฎุฏู</label>
                    <input type="text" id="adminUser">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>ูููุฉ ุงููุฑูุฑ</label>
                    <input type="password" id="adminPass">
                </div>
                <button onclick="login()" style="width: 100%; margin-bottom: 10px;">ุฏุฎูู</button>
                <button class="secondary" onclick="closeModal('authModal')" style="width: 100%;">ุฅูุบุงุก</button>
            </div>
        </div>

        <!-- Engagement Letter Modal -->
        <div id="letterModal" class="modal">
            <div class="modal-content">
                <h2 class="card-header">ุจูุงูุงุช ุฎุทุงุจ ุงูุงุฑุชุจุงุท</h2>
                <div class="form-grid" style="grid-template-columns: 1fr;">
                    <div class="form-group">
                        <label>ุงุณู ููุซู ุงูุนููู</label>
                        <input type="text" id="clientRep">
                    </div>
                    <div class="form-group">
                        <label>ููุตุจ ุงูููุซู</label>
                        <input type="text" id="clientPosition">
                    </div>
                    <div class="form-group">
                        <label>ุฑูู ุงูุณุฌู ุงูุชุฌุงุฑู</label>
                        <input type="text" id="crNumber">
                    </div>
                    <div class="form-group">
                        <label>ุนููุงู ุงูุดุฑูุฉ</label>
                        <input type="text" id="clientAddress">
                    </div>
                    <div class="form-group">
                        <label>ุชุงุฑูุฎ ุจุฏุงูุฉ ุงููุฑุงุฌุนุฉ</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="form-group">
                        <label>ูุณุจุฉ ุงูุฏูุน ุงูููุฏู (%)</label>
                        <input type="number" id="advancePercent" value="50">
                    </div>
                </div>
                <button onclick="generateLetter()" style="width: 100%; margin-bottom: 10px;">๐ ุฅุตุฏุงุฑ PDF (ุฅูุฌููุฒู)</button>
                <button onclick="generateWordLetter()" style="width: 100%; margin-bottom: 10px;">๐ ุฅุตุฏุงุฑ Word (ุนุฑุจู)</button>
                <button class="secondary" onclick="closeModal('letterModal')" style="width: 100%;">ุฅูุบุงุก</button>
            </div>
        </div>

        <div id="adminIndicator" class="admin-indicator hidden">
            ๐จโ๐ผ ุงููุฏูุฑ
            <button onclick="logout()" style="padding: 5px 15px; margin-right: 10px;">ุฎุฑูุฌ</button>
        </div>

        <button class="admin-btn" onclick="showModal('authModal')">๐ ุฏุฎูู ุงููุฏูุฑ</button>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('calc')">๐งฎ ุญุงุณุจุฉ ุงูุชุณุนูุฑ</div>
            <div class="tab admin-only hidden" onclick="switchTab('planning')">๐ ุงูุชุฎุทูุท ุงููุณุชูุจูู</div>
            <div class="tab admin-only hidden" onclick="switchTab('costs')">๐ฐ ุฅุฏุงุฑุฉ ุงูุชูุงููู</div>
            <div class="tab admin-only hidden" onclick="switchTab('clients')">๐ ุงูุนููุงุก</div>
        </div>

        <!-- Calculator Tab -->
        <div id="calcTab" class="tab-content active">
            <div class="card">
                <h2 class="card-header">ุญุงุณุจุฉ ุงูุชุณุนูุฑ</h2>
                
                <h3 class="section-title">ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>ุงุณู ุงูุนููู</label>
                        <input type="text" id="clientName">
                    </div>
                    <div class="form-group">
                        <label>ุณูุฉ ุงููุฑุงุฌุนุฉ</label>
                        <input type="number" id="year" value="2025">
                    </div>
                    <div class="form-group">
                        <label>ุญุฌู ุงูุฅูุฑุงุฏุงุช (ููููู ุฑูุงู)</label>
                        <input type="number" id="revenue" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>ุฅุฌูุงูู ุงูุฃุตูู (ููููู ุฑูุงู)</label>
                        <input type="number" id="assets" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>ุงูุฃุตูู ุงูุซุงุจุชุฉ (ููููู ุฑูุงู)</label>
                        <input type="number" id="fixedAssets" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>ููุน ุงููุดุงุท</label>
                        <select id="activity">
                            <option value="ุชุฌุงุฑู">ุชุฌุงุฑู</option>
                            <option value="ุตูุงุนู">ุตูุงุนู</option>
                            <option value="ุฎุฏูู">ุฎุฏูู</option>
                            <option value="ูุงูู">ูุงูู</option>
                        </select>
                    </div>
                </div>

                <h3 class="section-title">ุนูุงูู ุงูุชุนููุฏ</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>ุงููุฏูููู (ููููู ุฑูุงู)</label>
                        <input type="number" id="receivables" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>ุงูุฏุงุฆููู (ููููู ุฑูุงู)</label>
                        <input type="number" id="payables" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>ุนุฏุฏ ุงููุฑูุน</label>
                        <input type="number" id="branches" value="1">
                    </div>
                    <div class="form-group">
                        <label>ุฌูุฏุฉ ุงููุธุงู ุงููุญุงุณุจู</label>
                        <select id="systemQuality">
                            <option value="ุถุนูู">ุถุนูู</option>
                            <option value="ูุชูุณุท">ูุชูุณุท</option>
                            <option value="ููุชุงุฒ">ููุชุงุฒ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ูุณุชูู ุงูุฑูุงุจุฉ ุงูุฏุงุฎููุฉ</label>
                        <select id="internalControl">
                            <option value="ุถุนูู">ุถุนูู</option>
                            <option value="ูุชูุณุท">ูุชูุณุท</option>
                            <option value="ููู">ููู</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ููุน ุงูุนููู</label>
                        <select id="clientType">
                            <option value="ุฌุฏูุฏ">ุฌุฏูุฏ</option>
                            <option value="ูุชูุฑุฑ">ูุชูุฑุฑ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ุนุฏุฏ ุงูุญุณุงุจุงุช ุงูุจูููุฉ</label>
                        <input type="number" id="bankAccounts" value="1">
                    </div>
                    <div class="form-group">
                        <label>ูุนุงููุงุช ุนููุงุช ุฃุฌูุจูุฉ</label>
                        <select id="foreignCurrency">
                            <option value="ูุง">ูุง</option>
                            <option value="ูุนู">ูุนู</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ุฃุทุฑุงู ุฐุงุช ุนูุงูุฉ</label>
                        <select id="relatedParties">
                            <option value="ูุง">ูุง</option>
                            <option value="ูุนู">ูุนู</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ูุฌูุฏ ูุฎุฒูู</label>
                        <select id="inventory">
                            <option value="ูุง">ูุง</option>
                            <option value="ูุนู">ูุนู</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ุงููุฑูุถ ูุงูุชูููู</label>
                        <select id="loans">
                            <option value="ูุง">ูุง</option>
                            <option value="ูุนู">ูุนู</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ุงููุฎุตุตุงุช ูุงูุงุญุชูุงุทูุงุช</label>
                        <select id="provisions">
                            <option value="ูุง">ูุง</option>
                            <option value="ูุนู">ูุนู</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ุนููุฏ ุงูุฅูุฌุงุฑุงุช (IFRS 16)</label>
                        <select id="leases">
                            <option value="ูุง">ูุง</option>
                            <option value="ูุนู">ูุนู</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ุฅูุฑุงุฏุงุช ุงูุนููุฏ (IFRS 15)</label>
                        <select id="revenueContracts">
                            <option value="ูุง">ูุง</option>
                            <option value="ูุนู">ูุนู</option>
                        </select>
                    </div>
                </div>

                <button onclick="suggest()">๐ฎ ุงุญุณุจ ุงูุชุณุนูุฑ</button>

                <div id="prediction"></div>

                <div id="hoursAdjust" class="hidden">
                    <div class="hours-adjust">
                        <h3 class="result-title">โ๏ธ ุชุนุฏูู ุงูุณุงุนุงุช</h3>
                        <p style="color: #B8B8B8; margin-bottom: 15px;">ููููู ุงูููุงููุฉ ุนูู ุงูุณุงุนุงุช ุงูููุชุฑุญุฉ ุฃู ุชุนุฏูููุง</p>
                        
                        <div class="hours-row">
                            <label>ุณุงุนุงุช ุงูุดุฑูู:</label>
                            <input type="number" id="adjPartner" step="0.5">
                            <span class="suggested" id="sugPartner"></span>
                        </div>
                        
                        <div class="hours-row">
                            <label>ุณุงุนุงุช ุงูุฅุดุฑุงู:</label>
                            <input type="number" id="adjSupervisor" step="0.5">
                            <span class="suggested" id="sugSupervisor"></span>
                        </div>
                        
                        <div class="hours-row">
                            <label>ุณุงุนุงุช ุงูุนูู:</label>
                            <input type="number" id="adjStaff" step="0.5">
                            <span class="suggested" id="sugStaff"></span>
                        </div>

                        <div class="hours-row" style="border-top: 2px solid var(--primary); padding-top: 15px; margin-top: 15px;">
                            <label style="color: var(--accent); font-weight: 700;">ูุณุจุฉ ุงูุนูููุฉ (%):</label>
                            <input type="number" id="employeeCommission" value="0" step="0.5" style="border-color: var(--accent);">
                            <span class="suggested" style="color: var(--accent);">ุงุฎุชูุงุฑู</span>
                        </div>

                        <button onclick="calculate()">๐ ุงุญุณุจ ุงูุณุนุฑ</button>
                    </div>
                </div>

                <div id="pricing" class="result-box hidden">
                    <div class="result-title">๐ต ุงูุชุณุนูุฑ ุงูููุงุฆู</div>
                    
                    <!-- Summary Stats -->
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-label">ุฅุฌูุงูู ุงูุณุงุนุงุช</div>
                            <div class="stat-value" id="totalHours">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">ุงูุณุนุฑ ูุจู ุงูุถุฑูุจุฉ</div>
                            <div class="stat-value" id="priceBeforeVAT">0 ุฑูุงู</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">ุงูุณุนุฑ ุดุงูู ุงูุถุฑูุจุฉ 15%</div>
                            <div class="stat-value" id="totalPrice">0 ุฑูุงู</div>
                        </div>
                    </div>

                    <!-- Cost Breakdown -->
                    <div style="background: var(--darker); padding: 20px; border-radius: 10px; margin-top: 20px;">
                        <h3 style="color: var(--accent); margin-bottom: 15px; font-size: 1.2em;">๐ ุชูุงุตูู ุงูุชูุงููู</h3>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--card); border-radius: 8px;">
                                <span style="color: #B8B8B8;">ุงูุชูููุฉ ุงูุฃุณุงุณูุฉ:</span>
                                <span style="color: white; font-weight: 600;" id="baseCost">0 ุฑูุงู</span>
                            </div>
                            <div id="commissionBreakdown" class="hidden" style="display: flex; justify-content: space-between; padding: 10px; background: var(--card); border-radius: 8px; border: 2px solid var(--accent);">
                                <span style="color: var(--accent); font-weight: 600;">+ ุงูุนูููุฉ (<span id="commissionRateDisplay">0</span>%):</span>
                                <span style="color: var(--accent); font-weight: 700;" id="commissionAmountDisplay">0 ุฑูุงู</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 15px; background: linear-gradient(135deg, rgba(200,159,101,0.2), rgba(212,175,110,0.2)); border-radius: 8px; border: 2px solid var(--primary);">
                                <span style="color: var(--primary); font-weight: 700; font-size: 1.1em;">ุฅุฌูุงูู ุงูุชูููุฉ:</span>
                                <span style="color: var(--primary); font-weight: 700; font-size: 1.2em;" id="totalCostDisplay">0 ุฑุงู</span>
                            </div>
                            <div class="admin-only hidden" style="display: flex; justify-content: space-between; padding: 10px; background: var(--card); border-radius: 8px;">
                                <span style="color: #B8B8B8;">ูุงูุด ุงูุฑุจุญ:</span>
                                <span style="color: #51CF66; font-weight: 600;" id="marginDisplay">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="hours-adjust" style="margin-top: 20px;">
                        <h3 class="result-title">๐ฐ ุชุนุฏูู ุงูุณุนุฑ ุงูููุงุฆู</h3>
                        <p style="color: #B8B8B8; margin-bottom: 15px;">ุฅุฐุง ุงุชููุช ูุน ุงูุนููู ุนูู ุณุนุฑ ูุฎุชูู</p>
                        
                        <div class="hours-row">
                            <label>ุงูุณุนุฑ ุงููุชูู ุนููู (ูุจู ุงูุถุฑูุจุฉ):</label>
                            <input type="number" id="finalAgreedPrice" placeholder="ุงุชุฑูู ูุงุฑุบุงู ูุงุณุชุฎุฏุงู ุงูุณุนุฑ ุงูููุชุฑุญ">
                        </div>
                        
                        <div id="agreedPriceInfo" class="hidden" style="margin-top: 10px; padding: 10px; background: var(--darker); border-radius: 8px;">
                            <p style="color: var(--accent); font-size: 0.9em;">
                                ุงูุณุนุฑ ุงูููุชุฑุญ (ูุจู ุงูุถุฑูุจุฉ): <span id="suggestedPriceDisplay">0</span> ุฑูุงู<br>
                                ุงูุณุนุฑ ุงููุชูู ุนููู (ูุจู ุงูุถุฑูุจุฉ): <span id="agreedPriceDisplay">0</span> ุฑุงู<br>
                                ุงูุณุนุฑ ุงูููุงุฆู (ูุน ุงูุถุฑูุจุฉ 15%): <span id="agreedPriceWithVAT">0</span> ุฑูุงู<br>
                                <span id="priceDifference"></span>
                            </p>
                        </div>
                    </div>

                    <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="saveProposal()">๐พ ุญูุธ ุงูุนุฑุถ</button>
                        <button class="secondary" onclick="showModal('letterModal')">๐ ุฎุทุงุจ ุงุฑุชุจุงุท (PDF ุฅูุฌููุฒู)</button>
                        <button class="secondary" onclick="generateArabicLetter()">๐ ุฎุทุงุจ ุงุฑุชุจุงุท (Word ุนุฑุจู)</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Future Planning Tab -->
        <div id="planningTab" class="tab-content">
            <div class="card">
                <h2 class="card-header">ุงูุชุฎุทูุท ุงููุณุชูุจูู</h2>
                
                <h3 class="section-title">ุงูุณููุงุฑูู ุงููุณุชูุจูู</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>ุณุงุนุงุช ุงูุนูู ุงูุณูููุฉ ุงููุชููุนุฉ</label>
                        <input type="number" id="futureHours" value="10000">
                    </div>
                </div>

                <h3 class="section-title">ุงูุชูุงููู ุงูุดูุฑูุฉ ุงููุณุชูุจููุฉ</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>ุตูุงูุฉ ูุชูุธูู</label>
                        <input type="number" id="futureMaintenance" value="0">
                    </div>
                    <div class="form-group">
                        <label>ููุฑุจุงุก ููุงุก</label>
                        <input type="number" id="futureUtilities" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุงุชุตุงูุงุช ูุฅูุชุฑูุช</label>
                        <input type="number" id="futureCommunications" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุงุดุชุฑุงูุงุช ุจุฑูุฌูุงุช ูุชุฎุตุตุฉ</label>
                        <input type="number" id="futureSoftware" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุฑูุงุชุจ ุฅุฏุงุฑูุฉ</label>
                        <input type="number" id="futureAdmin" value="0">
                    </div>
                    <div class="form-group">
                        <label>ูุฑุทุงุณูุฉ ููุณุชูุฒูุงุช</label>
                        <input type="number" id="futureSupplies" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุชูุงููู ุดูุฑูุฉ ูุชููุนุฉ</label>
                        <input type="number" id="futureMonthlyMisc" value="0">
                    </div>
                </div>

                <h3 class="section-title">ุงูุชูุงููู ุงูุณูููุฉ ุงููุณุชูุจููุฉ</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>ุฅูุฌุงุฑ ุงูููุงุชุจ</label>
                        <input type="number" id="futureRent" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุชุฃูููุงุช</label>
                        <input type="number" id="futureInsurance" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุงุณุชููุงู ูุนุฏุงุช</label>
                        <input type="number" id="futureDepreciation" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุชุณููู ูุชุทููุฑ ุฃุนูุงู</label>
                        <input type="number" id="futureMarketing" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุฑุณูู SOCPA</label>
                        <input type="number" id="futureSocpa" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุชุฏุฑูุจ ูุดูุงุฏุงุช</label>
                        <input type="number" id="futureTraining" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุงุดุชุฑุงูุงุช ุจุฑูุฌูุงุช ุนุงูุฉ</label>
                        <input type="number" id="futureGeneralSoftware" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุชูุงููู ุณูููุฉ ูุชููุนุฉ</label>
                        <input type="number" id="futureAnnualMisc" value="0">
                    </div>
                </div>

                <h3 class="section-title">ุชูููุฉ ุงูุฑูุงุชุจ ุงููุณุชูุจููุฉ</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>ุฑุงุชุจ ุณุงุนุฉ ุงูุดุฑูู</label>
                        <input type="number" id="futurePartnerRate" value="800">
                    </div>
                    <div class="form-group">
                        <label>ุฑุงุชุจ ุณุงุนุฉ ุงูุฅุดุฑุงู</label>
                        <input type="number" id="futureSupervisorRate" value="400">
                    </div>
                    <div class="form-group">
                        <label>ุฑุงุชุจ ุณุงุนุฉ ุงูุนูู</label>
                        <input type="number" id="futureStaffRate" value="150">
                    </div>
                </div>

                <button onclick="comparePlanning()">๐ ูุงุฑู ุงููุถุน ุงูุญุงูู ุจุงููุณุชูุจูู</button>

                <div id="planningResult" class="hidden">
                    <div class="result-box">
                        <div class="result-title">๐ ููุงุฑูุฉ ุงูุชุฎุทูุท</div>
                        <table class="comparison-table">
                            <tr>
                                <td>ุงูุจูุงู</td>
                                <td>ุงููุถุน ุงูุญุงูู</td>
                                <td>ุงููุถุน ุงููุณุชูุจูู</td>
                                <td>ุงููุฑู</td>
                            </tr>
                            <tr>
                                <td>ุงูุชูุงููู ุงูุณูููุฉ</td>
                                <td id="currentAnnualCost">0</td>
                                <td id="futureAnnualCost">0</td>
                                <td id="costDiff">0</td>
                            </tr>
                            <tr>
                                <td>ุงูุชุญููู ููู ุณุงุนุฉ</td>
                                <td id="currentPerHour">0</td>
                                <td id="futurePerHour">0</td>
                                <td id="perHourDiff">0</td>
                            </tr>
                            <tr>
                                <td>ุชูููุฉ ุงูุณุงุนุฉ ุงููุงููุฉ</td>
                                <td id="currentFullCost">0</td>
                                <td id="futureFullCost">0</td>
                                <td id="fullCostDiff">0</td>
                            </tr>
                            <tr>
                                <td>ุงูุณุนุฑ ุงููุทููุจ ููุนููู</td>
                                <td id="currentClientPrice">0</td>
                                <td id="futureClientPrice">0</td>
                                <td id="clientPriceDiff">0</td>
                            </tr>
                        </table>
                    </div>

                    <div class="result-box">
                        <div class="result-title">๐ก ุงูุชูุตูุงุช</div>
                        <div id="recommendations" style="line-height: 1.8;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Costs Tab -->
        <div id="costsTab" class="tab-content">
            <div class="card">
                <h2 class="card-header">ุฅุฏุงุฑุฉ ุงูุชูุงููู</h2>
                
                <h3 class="section-title">ุณุงุนุงุช ุงูุนูู ุงูุณูููุฉ</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>ุฅุฌูุงูู ุณุงุนุงุช ุงูุนูู ุงููุจุงุดุฑ ุงูุณูููุฉ</label>
                        <input type="number" id="annualHours" value="10000">
                    </div>
                </div>

                <h3 class="section-title">ุงูุชูุงููู ุงูุดูุฑูุฉ (ุฑูุงู)</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>ุตูุงูุฉ ูุชูุธูู</label>
                        <input type="number" id="maintenance" value="0">
                    </div>
                    <div class="form-group">
                        <label>ููุฑุจุงุก ููุงุก</label>
                        <input type="number" id="utilities" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุงุชุตุงูุงุช ูุฅูุชุฑูุช</label>
                        <input type="number" id="communications" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุงุดุชุฑุงูุงุช ุจุฑูุฌูุงุช ูุชุฎุตุตุฉ</label>
                        <input type="number" id="software" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุฑูุงุชุจ ุฅุฏุงุฑูุฉ</label>
                        <input type="number" id="adminSalaries" value="0">
                    </div>
                    <div class="form-group">
                        <label>ูุฑุทุงุณูุฉ ููุณุชูุฒูุงุช</label>
                        <input type="number" id="supplies" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุชูุงููู ุดูุฑูุฉ ูุชููุนุฉ</label>
                        <input type="number" id="monthlyMisc" value="0">
                    </div>
                </div>

                <h3 class="section-title">ุงูุชูุงููู ุงูุณูููุฉ (ุฑูุงู)</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>ุฅูุฌุงุฑ ุงูููุงุชุจ</label>
                        <input type="number" id="rent" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุชุฃูููุงุช</label>
                        <input type="number" id="insurance" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุงุณุชููุงู ูุนุฏุงุช</label>
                        <input type="number" id="depreciation" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุชุณููู ูุชุทููุฑ ุฃุนูุงู</label>
                        <input type="number" id="marketing" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุฑุณูู SOCPA</label>
                        <input type="number" id="socpa" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุชุฏุฑูุจ ูุดูุงุฏุงุช</label>
                        <input type="number" id="training" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุงุดุชุฑุงูุงุช ุจุฑูุฌูุงุช ุนุงูุฉ</label>
                        <input type="number" id="generalSoftware" value="0">
                    </div>
                    <div class="form-group">
                        <label>ุชูุงููู ุณูููุฉ ูุชููุนุฉ</label>
                        <input type="number" id="annualMisc" value="0">
                    </div>
                </div>

                <h3 class="section-title">ุชูููุฉ ุงูุฑูุงุชุจ ุจุงูุณุงุนุฉ (ุฑูุงู)</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>ุฑุงุชุจ ุณุงุนุฉ ุงูุดุฑูู</label>
                        <input type="number" id="partnerRate" value="800">
                    </div>
                    <div class="form-group">
                        <label>ุฑุงุชุจ ุณุงุนุฉ ุงูุฅุดุฑุงู</label>
                        <input type="number" id="supervisorRate" value="400">
                    </div>
                    <div class="form-group">
                        <label>ุฑุงุชุจ ุณุงุนุฉ ุงูุนูู</label>
                        <input type="number" id="staffRate" value="150">
                    </div>
                </div>

                <h3 class="section-title">ูุงูุด ุงูุฑุจุญ ูุงูุนูููุงุช</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>ูุงูุด ุงูุฑุจุญ ุงููุณุชูุฏู (%)</label>
                        <input type="number" id="profitMargin" value="30">
                    </div>
                    <div class="form-group">
                        <label>ูุณุจุฉ ุงูุนูููุฉ (%)</label>
                        <input type="number" id="commissionRate" value="0" step="0.5" onchange="calcCostSummary()">
                    </div>
                </div>

                <div class="result-box">
                    <div class="result-title">๐ ููุฎุต ุงูุชูุงููู</div>
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-label">ุงูุชูุงููู ุงูุณูููุฉ</div>
                            <div class="stat-value" id="annualTotal">0 ุฑูุงู</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">ุงูุชุญููู ููู ุณุงุนุฉ</div>
                            <div class="stat-value" id="perHour">0 ุฑูุงู</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">ูุณุจุฉ ุงูุนูููุฉ</div>
                            <div class="stat-value" id="commissionDisplay">0%</div>
                        </div>
                    </div>
                </div>

                <button onclick="saveCosts()">๐พ ุญูุธ ุงูุชูุงููู</button>
                
                <h3 class="section-title">ุงููุณุฎ ุงูุงุญุชูุงุทู</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="secondary" onclick="exportData()">๐ฅ ุชุตุฏูุฑ ุงูุจูุงูุงุช</button>
                    <button class="secondary" onclick="document.getElementById('importFile').click()">๐ค ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                </div>
            </div>
        </div>

        <!-- Clients Tab -->
        <div id="clientsTab" class="tab-content">
            <div class="card">
                <h2 class="card-header">ุงูุจูุงูุงุช ุงูุชุงุฑูุฎูุฉ ููุนููุงุก</h2>
                
                <div class="form-grid" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>ุจุญุซ</label>
                        <input type="text" id="searchClients" placeholder="ุงุณู ุงูุนูููุ ุงููุดุงุท..." onkeyup="filterClients()">
                    </div>
                    <div class="form-group">
                        <label>ุชุตููุฉ ุญุณุจ ุงููุดุงุท</label>
                        <select id="filterActivity" onchange="filterClients()">
                            <option value="">ุงููู</option>
                            <option value="ุชุฌุงุฑู">ุชุฌุงุฑู</option>
                            <option value="ุตูุงุนู">ุตูุงุนู</option>
                            <option value="ุฎุฏูู">ุฎุฏูู</option>
                            <option value="ูุงูู">ูุงูู</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ุชุตููุฉ ุญุณุจ ุงูุณูุฉ</label>
                        <select id="filterYear" onchange="filterClients()">
                            <option value="">ุงููู</option>
                        </select>
                    </div>
                </div>

                <div class="result-box">
                    <div class="result-title">๐ ุฅุญุตุงุฆูุงุช</div>
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-label">ุฅุฌูุงูู ุงูุนููุงุก</div>
                            <div class="stat-value" id="totalClients">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">ูุชูุณุท ุงูุณุงุนุงุช</div>
                            <div class="stat-value" id="avgHours">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">ูุชูุณุท ุงูุณุนุฑ</div>
                            <div class="stat-value" id="avgPrice">0 ุฑูุงู</div>
                        </div>
                    </div>
                </div>

                <div id="clientsList"></div>
                
                <button class="secondary" onclick="exportClients()" style="margin-top: 20px;">๐ฅ ุชุตุฏูุฑ Excel</button>
            </div>
        </div>
    </div>

    <script>
        let isAdmin = false;
        let clients = JSON.parse(localStorage.getItem('clients') || '[]');
        let costs = JSON.parse(localStorage.getItem('costs') || '{}');
        let sugHours = {};
        let currentProposal = {};

        function showModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function login() {
            const u = document.getElementById('adminUser').value;
            const p = document.getElementById('adminPass').value;
            if (u === 'admin' && p === 'admin123') {
                isAdmin = true;
                document.getElementById('adminIndicator').classList.remove('hidden');
                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
                closeModal('authModal');
                alert('ุชู ุชุณุฌูู ุงูุฏุฎูู');
                loadClients();
            } else {
                alert('ุฎุทุฃ ูู ุงูุจูุงูุงุช');
            }
        }

        function logout() {
            isAdmin = false;
            document.getElementById('adminIndicator').classList.add('hidden');
            document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
            switchTab('calc');
        }

        function switchTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(name + 'Tab').classList.add('active');
            if (name === 'clients') loadClients();
            if (name === 'costs') loadCostsForm();
            if (name === 'planning') loadPlanningForm();
        }

        function suggest() {
            const clientData = {
                revenue: parseFloat(document.getElementById('revenue').value) || 0,
                assets: parseFloat(document.getElementById('assets').value) || 0,
                fixedAssets: parseFloat(document.getElementById('fixedAssets').value) || 0,
                receivables: parseFloat(document.getElementById('receivables').value) || 0,
                payables: parseFloat(document.getElementById('payables').value) || 0,
                activity: document.getElementById('activity').value,
                branches: parseInt(document.getElementById('branches').value) || 1,
                systemQuality: document.getElementById('systemQuality').value,
                internalControl: document.getElementById('internalControl').value,
                clientType: document.getElementById('clientType').value,
                bankAccounts: parseInt(document.getElementById('bankAccounts').value) || 1,
                foreignCurrency: document.getElementById('foreignCurrency').value,
                relatedParties: document.getElementById('relatedParties').value,
                inventory: document.getElementById('inventory').value,
                loans: document.getElementById('loans').value,
                provisions: document.getElementById('provisions').value,
                leases: document.getElementById('leases').value,
                revenueContracts: document.getElementById('revenueContracts').value
            };

            if (clientData.revenue === 0 || clientData.assets === 0) {
                alert('ุฃุฏุฎู ุงูุฅูุฑุงุฏุงุช ูุงูุฃุตูู ุนูู ุงูุฃูู');
                return;
            }

            // Find similar clients (ยฑ10% for numeric fields)
            const similarClients = clients.filter(c => {
                // Must match activity
                if (c.activity !== clientData.activity) return false;

                // Check numeric fields (ยฑ10%)
                const fields = ['revenue', 'assets', 'fixedAssets', 'receivables', 'payables'];
                let matchCount = 0;
                let totalFields = 0;

                fields.forEach(field => {
                    if (clientData[field] > 0) {
                        totalFields++;
                        const diff = Math.abs(c[field] - clientData[field]) / clientData[field];
                        if (diff <= 0.10) { // Within 10%
                            matchCount++;
                        }
                    }
                });

                // At least 60% of numeric fields must match
                const matchRatio = totalFields > 0 ? (matchCount / totalFields) : 0;
                if (matchRatio < 0.6) return false;

                // Check categorical fields - bonus points for exact matches
                let bonusScore = 0;
                if (c.branches === clientData.branches) bonusScore++;
                if (c.systemQuality === clientData.systemQuality) bonusScore++;
                if (c.internalControl === clientData.internalControl) bonusScore++;
                if (c.clientType === clientData.clientType) bonusScore++;
                if (c.bankAccounts === clientData.bankAccounts) bonusScore++;
                if (c.foreignCurrency === clientData.foreignCurrency) bonusScore++;
                if (c.relatedParties === clientData.relatedParties) bonusScore++;
                if (c.inventory === clientData.inventory) bonusScore++;
                if (c.loans === clientData.loans) bonusScore++;
                if (c.provisions === clientData.provisions) bonusScore++;
                if (c.leases === clientData.leases) bonusScore++;
                if (c.revenueContracts === clientData.revenueContracts) bonusScore++;

                // Store similarity score for ranking
                c.similarityScore = matchRatio + (bonusScore * 0.05);
                return true;
            });

            let p, s, st;
            
            if (similarClients.length === 0) {
                // No similar clients - use formula-based estimation
                let base = 40;
                
                // Revenue impact
                if (clientData.revenue > 100) base += 30;
                else if (clientData.revenue > 50) base += 20;
                else if (clientData.revenue > 20) base += 10;
                
                // Assets impact
                if (clientData.assets > 200) base += 25;
                else if (clientData.assets > 100) base += 15;
                else if (clientData.assets > 50) base += 8;
                
                // Activity complexity
                if (clientData.activity === 'ูุงูู') base += 30;
                else if (clientData.activity === 'ุตูุงุนู') base += 20;
                else if (clientData.activity === 'ุชุฌุงุฑู') base += 10;
                
                // Fixed assets
                if (clientData.fixedAssets > 50) base += 20;
                else if (clientData.fixedAssets > 20) base += 12;
                else if (clientData.fixedAssets > 5) base += 6;
                
                // Receivables & Payables
                if (clientData.receivables > 30) base += 15;
                else if (clientData.receivables > 15) base += 10;
                if (clientData.payables > 30) base += 12;
                else if (clientData.payables > 15) base += 8;
                
                // Other factors
                base += (clientData.branches - 1) * 5;
                base += (clientData.bankAccounts - 1) * 3;
                
                if (clientData.systemQuality === 'ุถุนูู') base += 20;
                else if (clientData.systemQuality === 'ูุชูุณุท') base += 10;
                
                if (clientData.internalControl === 'ุถุนูู') base += 15;
                else if (clientData.internalControl === 'ูุชูุณุท') base += 8;
                
                if (clientData.clientType === 'ุฌุฏูุฏ') base += 15;
                
                if (clientData.foreignCurrency === 'ูุนู') base += 10;
                if (clientData.relatedParties === 'ูุนู') base += 12;
                if (clientData.inventory === 'ูุนู') base += 15;
                if (clientData.loans === 'ูุนู') base += 12;
                if (clientData.provisions === 'ูุนู') base += 10;
                if (clientData.leases === 'ูุนู') base += 18;
                if (clientData.revenueContracts === 'ูุนู') base += 16;
                
                p = Math.round(base * 0.15);
                s = Math.round(base * 0.25);
                st = base - p - s;
                
                document.getElementById('prediction').innerHTML = `
                    <div class="result-box">
                        <div class="result-title">๐ฎ ุงูุชููุน ุงูุฃุณุงุณู (ุจุฏูู ุจูุงูุงุช ูุดุงุจูุฉ)</div>
                        <p style="color: #B8B8B8; margin-bottom: 15px;">ูุง ุชูุฌุฏ ุนููุงุก ูุดุงุจููู ูู ุงูุจูุงูุงุช ุงูุชุงุฑูุฎูุฉ. ุงูุชููุน ูุจูู ุนูู ุงูุฎูุงุฑุฒููุฉ ุงูุฃุณุงุณูุฉ.</p>
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-label">ุงูุณุงุนุงุช ุงููุชููุนุฉ</div>
                                <div class="stat-value">${base}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">ุดุฑูู</div>
                                <div class="stat-value">${p}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">ุฅุดุฑุงู</div>
                                <div class="stat-value">${s}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">ุนูู</div>
                                <div class="stat-value">${st}</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Sort by similarity score
                similarClients.sort((a, b) => b.similarityScore - a.similarityScore);
                
                // Calculate weighted average (higher weight for more similar clients)
                let totalWeight = 0;
                let weightedPartner = 0;
                let weightedSupervisor = 0;
                let weightedStaff = 0;
                
                similarClients.forEach((c, index) => {
                    const weight = 1 / (index + 1); // Higher weight for more similar
                    totalWeight += weight;
                    weightedPartner += c.partnerHours * weight;
                    weightedSupervisor += c.supervisorHours * weight;
                    weightedStaff += c.staffHours * weight;
                });
                
                p = Math.round(weightedPartner / totalWeight);
                s = Math.round(weightedSupervisor / totalWeight);
                st = Math.round(weightedStaff / totalWeight);
                
                // Show top 3 similar clients
                let similarTable = '<table style="margin-top: 15px; font-size: 0.9em;"><thead><tr><th>ุงูุนููู</th><th>ุงูุชุดุงุจู</th><th>ุงูุณุงุนุงุช</th></tr></thead><tbody>';
                similarClients.slice(0, 3).forEach(c => {
                    const similarity = (c.similarityScore * 100).toFixed(0);
                    similarTable += `<tr><td>${c.name}</td><td>${similarity}%</td><td>${c.totalHours}</td></tr>`;
                });
                similarTable += '</tbody></table>';
                
                document.getElementById('prediction').innerHTML = `
                    <div class="result-box">
                        <div class="result-title">๐ฏ ุชููุน ุฐูู ูู ุงูุจูุงูุงุช ุงูุชุงุฑูุฎูุฉ</div>
                        <p style="color: var(--accent); margin-bottom: 15px;">
                            ุชู ุฅูุฌุงุฏ <strong>${similarClients.length}</strong> ุนููู ูุดุงุจู ุจูุณุจุฉ ุชุทุงุจู ุนุงููุฉ
                        </p>
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-label">ุงูุณุงุนุงุช ุงููุชููุนุฉ</div>
                                <div class="stat-value">${p + s + st}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">ุดุฑูู</div>
                                <div class="stat-value">${p}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">ุฅุดุฑุงู</div>
                                <div class="stat-value">${s}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">ุนูู</div>
                                <div class="stat-value">${st}</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h4 style="color: var(--secondary); margin-bottom: 10px;">ุฃูุซุฑ 3 ุนููุงุก ุชุดุงุจูุงู:</h4>
                            ${similarTable}
                        </div>
                    </div>
                `;
            }

            sugHours = { partner: p, supervisor: s, staff: st };
            document.getElementById('adjPartner').value = p;
            document.getElementById('adjSupervisor').value = s;
            document.getElementById('adjStaff').value = st;
            document.getElementById('sugPartner').textContent = `ููุชุฑุญ: ${p}`;
            document.getElementById('sugSupervisor').textContent = `ููุชุฑุญ: ${s}`;
            document.getElementById('sugStaff').textContent = `ููุชุฑุญ: ${st}`;
            document.getElementById('hoursAdjust').classList.remove('hidden');
        }

        function calculate() {
            const p = parseFloat(document.getElementById('adjPartner').value) || 0;
            const s = parseFloat(document.getElementById('adjSupervisor').value) || 0;
            const st = parseFloat(document.getElementById('adjStaff').value) || 0;
            const total = p + s + st;

            const monthly = ['maintenance','utilities','communications','software','adminSalaries','supplies','monthlyMisc']
                .reduce((sum, id) => sum + (parseFloat(document.getElementById(id)?.value) || 0), 0) * 12;
            const annual = ['rent','insurance','depreciation','marketing','socpa','training','generalSoftware','annualMisc']
                .reduce((sum, id) => sum + (parseFloat(document.getElementById(id)?.value) || 0), 0);
            const overhead = (monthly + annual) / (parseFloat(document.getElementById('annualHours')?.value) || 10000);

            const pr = parseFloat(document.getElementById('partnerRate')?.value) || 800;
            const sr = parseFloat(document.getElementById('supervisorRate')?.value) || 400;
            const str = parseFloat(document.getElementById('staffRate')?.value) || 150;
            const salaryCost = (p * pr) + (s * sr) + (st * str);
            const avgSalary = salaryCost / total;
            const costPerHour = avgSalary + overhead;
            const totalCost = total * costPerHour;
            const margin = parseFloat(document.getElementById('profitMargin')?.value) || 30;
            const priceBeforeVAT = totalCost * (1 + margin / 100);
            
            // Calculate commission from employee input (overrides admin setting)
            const employeeCommission = parseFloat(document.getElementById('employeeCommission')?.value) || 0;
            const commissionRate = employeeCommission; // Use employee's commission
            const commissionAmount = priceBeforeVAT * (commissionRate / 100);
            const totalCostWithCommission = totalCost + commissionAmount;
            
            const totalPrice = priceBeforeVAT * 1.15; // ูุน ุถุฑูุจุฉ 15%
            
            // Recalculate actual margin after commission
            const actualMargin = commissionRate > 0 ? 
                ((priceBeforeVAT - totalCostWithCommission) / totalCostWithCommission * 100).toFixed(1) : 
                margin;

            currentProposal = {
                totalHours: total,
                partnerHours: p,
                supervisorHours: s,
                staffHours: st,
                totalCost: totalCost,
                commissionAmount: commissionAmount,
                totalCostWithCommission: totalCostWithCommission,
                priceBeforeVAT: priceBeforeVAT,
                totalPrice: totalPrice,
                margin: margin,
                actualMargin: actualMargin,
                commissionRate: commissionRate
            };

            document.getElementById('totalHours').textContent = total.toFixed(1);
            document.getElementById('priceBeforeVAT').textContent = Math.round(priceBeforeVAT).toLocaleString() + ' ุฑูุงู';
            document.getElementById('totalPrice').textContent = Math.round(totalPrice).toLocaleString() + ' ุฑูุงู';
            
            // Cost breakdown
            document.getElementById('baseCost').textContent = Math.round(totalCost).toLocaleString() + ' ุฑูุงู';
            document.getElementById('totalCostDisplay').textContent = Math.round(totalCostWithCommission).toLocaleString() + ' ุฑูุงู';
            
            if (commissionRate > 0) {
                document.getElementById('commissionBreakdown').classList.remove('hidden');
                document.getElementById('commissionRateDisplay').textContent = commissionRate;
                document.getElementById('commissionAmountDisplay').textContent = Math.round(commissionAmount).toLocaleString() + ' ุฑูุงู';
            } else {
                document.getElementById('commissionBreakdown').classList.add('hidden');
            }
            
            if (isAdmin) {
                document.getElementById('marginDisplay').textContent = commissionRate > 0 ? 
                    `${actualMargin}% (ุจุนุฏ ุนูููุฉ ${commissionRate}%)` : 
                    `${margin}%`;
            }
            
            // Setup final price adjustment
            document.getElementById('suggestedPriceDisplay').textContent = Math.round(priceBeforeVAT).toLocaleString();
            document.getElementById('finalAgreedPrice').addEventListener('input', updateAgreedPrice);
            
            document.getElementById('pricing').classList.remove('hidden');
        }

        function updateAgreedPrice() {
            const agreedPriceBeforeVAT = parseFloat(document.getElementById('finalAgreedPrice').value);
            const suggestedPriceBeforeVAT = currentProposal.priceBeforeVAT;
            
            if (agreedPriceBeforeVAT && agreedPriceBeforeVAT > 0) {
                document.getElementById('agreedPriceInfo').classList.remove('hidden');
                document.getElementById('agreedPriceDisplay').textContent = Math.round(agreedPriceBeforeVAT).toLocaleString();
                
                const agreedPriceWithVAT = agreedPriceBeforeVAT * 1.15;
                document.getElementById('agreedPriceWithVAT').textContent = Math.round(agreedPriceWithVAT).toLocaleString();
                
                const difference = agreedPriceBeforeVAT - suggestedPriceBeforeVAT;
                const percentage = ((difference / suggestedPriceBeforeVAT) * 100).toFixed(1);
                
                if (difference > 0) {
                    document.getElementById('priceDifference').innerHTML = 
                        `<span style="color: #51CF66;">โฒ ุฒูุงุฏุฉ: ${Math.round(difference).toLocaleString()} ุฑูุงู (${percentage}%)</span>`;
                } else if (difference < 0) {
                    document.getElementById('priceDifference').innerHTML = 
                        `<span style="color: #FF6B6B;">โผ ุชุฎููุถ: ${Math.round(Math.abs(difference)).toLocaleString()} ุฑูุงู (${percentage}%)</span>`;
                } else {
                    document.getElementById('priceDifference').innerHTML = 
                        `<span style="color: var(--accent);">โ ููุณ ุงูุณุนุฑ ุงูููุชุฑุญ</span>`;
                }
                
                // Update current proposal with agreed prices
                currentProposal.agreedPriceBeforeVAT = agreedPriceBeforeVAT;
                currentProposal.agreedPrice = agreedPriceWithVAT;
            } else {
                document.getElementById('agreedPriceInfo').classList.add('hidden');
                currentProposal.agreedPriceBeforeVAT = null;
                currentProposal.agreedPrice = null;
            }
        }

        function saveProposal() {
            const name = document.getElementById('clientName').value;
            if (!name) {
                alert('ุฃุฏุฎู ุงุณู ุงูุนููู');
                return;
            }

            if (!currentProposal.totalHours) {
                alert('ุงุญุณุจ ุงูุชุณุนูุฑ ุฃููุงู');
                return;
            }

            // Use agreed price if provided, otherwise use calculated price
            const finalPrice = currentProposal.agreedPrice || currentProposal.totalPrice;

            const client = {
                id: Date.now(),
                name,
                year: document.getElementById('year').value,
                
                // Financial data
                revenue: parseFloat(document.getElementById('revenue').value) || 0,
                assets: parseFloat(document.getElementById('assets').value) || 0,
                fixedAssets: parseFloat(document.getElementById('fixedAssets').value) || 0,
                receivables: parseFloat(document.getElementById('receivables').value) || 0,
                payables: parseFloat(document.getElementById('payables').value) || 0,
                
                // Activity & complexity
                activity: document.getElementById('activity').value,
                branches: parseInt(document.getElementById('branches').value) || 1,
                systemQuality: document.getElementById('systemQuality').value,
                internalControl: document.getElementById('internalControl').value,
                clientType: document.getElementById('clientType').value,
                
                // Additional factors
                bankAccounts: parseInt(document.getElementById('bankAccounts').value) || 1,
                foreignCurrency: document.getElementById('foreignCurrency').value,
                relatedParties: document.getElementById('relatedParties').value,
                inventory: document.getElementById('inventory').value,
                loans: document.getElementById('loans').value,
                provisions: document.getElementById('provisions').value,
                leases: document.getElementById('leases').value,
                revenueContracts: document.getElementById('revenueContracts').value,
                
                // Hours & pricing
                partnerHours: currentProposal.partnerHours,
                supervisorHours: currentProposal.supervisorHours,
                staffHours: currentProposal.staffHours,
                totalHours: currentProposal.totalHours,
                suggestedPrice: currentProposal.totalPrice,
                price: finalPrice,
                priceAdjusted: currentProposal.agreedPrice ? true : false
            };

            clients.push(client);
            localStorage.setItem('clients', JSON.stringify(clients));
            
            const msg = currentProposal.agreedPrice ? 
                `โ ุชู ุญูุธ ุงูุนุฑุถ!\n\nุงูุณุนุฑ ุงูููุชุฑุญ: ${Math.round(currentProposal.totalPrice).toLocaleString()} ุฑุงู\nุงูุณุนุฑ ุงููุชูู ุนููู: ${Math.round(finalPrice).toLocaleString()} ุฑุงู` :
                'โ ุชู ุญูุธ ุงูุนุฑุถ ูู ุงูุจูุงูุงุช ุงูุชุงุฑูุฎูุฉ!';
            
            alert(msg);
            
            // Reset form
            document.querySelectorAll('input[type="text"], input[type="number"]').forEach(i => {
                if (!i.id.includes('Rate') && !i.id.includes('Margin') && !i.id.includes('annual') && 
                    !i.id.includes('maintenance') && !i.id.includes('utilities') && !i.id.includes('communications') &&
                    !i.id.includes('software') && !i.id.includes('adminSalaries') && !i.id.includes('supplies') &&
                    !i.id.includes('insurance') && !i.id.includes('depreciation') && !i.id.includes('marketing') &&
                    !i.id.includes('socpa') && !i.id.includes('training') && !i.id.includes('rent') &&
                    !i.id.includes('generalSoftware') && !i.id.includes('Misc')) {
                    i.value = i.defaultValue || '';
                }
            });
            document.getElementById('prediction').innerHTML = '';
            document.getElementById('hoursAdjust').classList.add('hidden');
            document.getElementById('pricing').classList.add('hidden');
        }

        function generateArabicLetter() {
            const clientName = document.getElementById('clientName').value;
            const year = document.getElementById('year').value;

            if (!clientName) {
                alert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุนููู ุฃููุงู');
                return;
            }

            if (!currentProposal.totalPrice) {
                alert('ูุฑุฌู ุญุณุงุจ ุงูุชุณุนูุฑ ุฃููุงู');
                return;
            }

            // Show modal for additional data
            showModal('letterModal');
        }

        function generateWordLetter() {
            const clientName = document.getElementById('clientName').value;
            const clientRep = document.getElementById('clientRep').value;
            const clientPosition = document.getElementById('clientPosition').value;
            const crNumber = document.getElementById('crNumber').value;
            const clientAddress = document.getElementById('clientAddress').value;
            const year = document.getElementById('year').value;
            const startDate = document.getElementById('startDate').value;
            const advancePercent = parseFloat(document.getElementById('advancePercent').value) || 50;

            if (!clientName || !clientRep || !crNumber || !clientAddress) {
                alert('ูุฑุฌู ุฅุฏุฎุงู ุฌููุน ุงูุจูุงูุงุช ุงููุทููุจุฉ');
                return;
            }

            const priceBeforeVAT = currentProposal.priceBeforeVAT || 0;
            const vat = priceBeforeVAT * 0.15;
            const totalPrice = priceBeforeVAT + vat;
            const advance = totalPrice * (advancePercent / 100);
            const remaining = totalPrice - advance;
            const today = new Date().toLocaleDateString('ar-SA');
            const startYear = startDate ? new Date(startDate).getFullYear() : year;

            // Create HTML for Word
            const html = `
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: 'Simplified Arabic', 'Arial', sans-serif;
            direction: rtl;
            text-align: right;
            line-height: 1.8;
            padding: 40px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 24pt;
            font-weight: bold;
            margin: 10px 0;
        }
        .date {
            text-align: right;
            margin-bottom: 20px;
        }
        .client-info {
            margin: 20px 0;
            line-height: 2;
        }
        .section-title {
            font-weight: bold;
            font-size: 12pt;
            margin: 20px 0 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        table, th, td {
            border: 1px solid #000;
        }
        th, td {
            padding: 10px;
            text-align: right;
        }
        th {
            background-color: #C89F65;
            font-weight: bold;
        }
        .signature-table {
            margin-top: 40px;
        }
        .signature-table td {
            vertical-align: top;
            height: 100px;
        }
        p {
            text-align: justify;
            margin: 10px 0;
        }
        ul {
            margin: 10px 0 10px 30px;
        }
        li {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="date">${today}</div>
    
    <div class="header">
        <h1>ุฎุทุงุจ ุงูุงุฑุชุจุงุท</h1>
    </div>

    <div class="client-info">
        <p><strong>ุงูุณุงุฏุฉ / ${clientName}</strong> ุงููุญุชุฑููู</p>
        <p>ุณุฌู ุชุฌุงุฑู ุฑูู: ${crNumber}</p>
        <p>${clientAddress}ุ ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ</p>
    </div>

    <div class="section-title">ุฎุฏูุงุช ุงููุฑุงุฌุนุฉ ููุณูุฉ ุงูููุชููุฉ ูู 31 ุฏูุณูุจุฑ ${year}ู</div>

    <p>ุณููููุ ุจูุงุก ุนูู ุทูุจููุ ุจูุฑุงุฌุนุฉ ุงูุจูุงูุงุช ุงููุงููุฉ ู${clientName} ูุงูุชู ุชุดูู ุจูุงู ุงููุฑูุฒ ุงููุงูู ุงูููุชูู ูู 31 ุฏูุณูุจุฑ ${year}ูุ ูุจูุงู ุงูุฑุจุญ ุฃู ุงูุฎุณุงุฑุฉ ูุงูุฏุฎู ุงูุดุงูู ุงูุขุฎุฑุ ูุจูุงู ุงูุชุบูุฑุงุช ูู ุญููู ุงููุณุงูููู ูุจูุงู ุงูุชุฏููุงุช ุงูููุฏูุฉ ููุณูุฉ ุงูููุชููุฉ ูู ุฐูู ุงูุชุงุฑูุฎุ ูุงูุฅูุถุงุญุงุช ุญูู ุงูุจูุงูุงุช ุงููุงููุฉุ ุจูุง ูู ุฐูู ููุฎุต ุงูุณูุงุณุงุช ุงููุญุงุณุจูุฉ ุงููุงูุฉ. ูุณุนุฏูุง ุฃู ูุคูุฏ ููู ูุจูููุง ูููููุง ููุฐู ุงููููุฉ ูู ุฎูุงู ูุฐุง ุงูุฎุทุงุจ.</p>

    <p>ุฅู ุฃูุฏุงู ูุฑุงุฌุนุชูุง ูู ุงูุญุตูู ุนูู ุชุฃููุฏ ูุนููู ุญูู ูุง ุฅุฐุง ูุงูุช ุงูุจูุงูุงุช ุงููุงููุฉ ููู ุฎุงููุฉ ูู ุงูุฃุฎุทุงุก ุงูุฌููุฑูุฉุ ุณูุงุก ูุงูุช ูุงุชุฌุฉ ุนู ุงูุงุญุชูุงู ุฃู ุงูุฎุทุฃุ ูุฅุตุฏุงุฑ ุชูุฑูุฑ ูุฑุงุฌุน ุงูุญุณุงุจุงุช ุงูุฐู ูุชุถูู ุฑุฃููุง.</p>

    <div class="section-title">ูุณุคูููุงุช ูุฑุงุฌุน ุงูุญุณุงุจุงุช:</div>
    <p>ุณูููู ุจูุฑุงุฌุนุฉ ุงูุญุณุงุจุงุช ููููุง ููุนุงููุฑ ุงููุฑุงุฌุนุฉ ุงูุฏูููุฉ. ุชุชุทูุจ ูุฐู ุงููุนุงููุฑ ุฃู ููุชุฒู ุจุงููุชุทูุจุงุช ุงูุฃุฎูุงููุฉ. ููุง ูููู ุฃูุถุงู ุจูุง ููู:</p>
    <ul>
        <li>ุชุญุฏูุฏ ูุชูููู ูุฎุงุทุฑ ุงูุฃุฎุทุงุก ุงูุฌููุฑูุฉ ูู ุงูุจูุงูุงุช ุงููุงููุฉ</li>
        <li>ุงูุญุตูู ุนูู ููู ููุฑูุงุจุฉ ุงูุฏุงุฎููุฉ ุฐุงุช ุงูุตูุฉ ุจุงููุฑุงุฌุนุฉ</li>
        <li>ุชูููู ููุงุกูุฉ ุงูุณูุงุณุงุช ุงููุญุงุณุจูุฉ ุงููุณุชุฎุฏูุฉ</li>
        <li>ุงุณุชูุชุงุฌ ูุฏู ููุงุกูุฉ ุงุณุชุฎุฏุงู ุงูุฅุฏุงุฑุฉ ููุจุฏุฃ ุงูุงุณุชูุฑุงุฑูุฉ ุงููุญุงุณุจู</li>
    </ul>

    <div class="section-title">ูุณุคูููุงุช ุงูุฅุฏุงุฑุฉ ูุงููููููู ุจุงูุญูููุฉ:</div>
    <p>ุณูุชู ุฅุฌุฑุงุก ุงููุฑุงุฌุนุฉ ุนูู ุฃุณุงุณ ุฃู ุงูุฅุฏุงุฑุฉ ุชูุฑ ูุชููู ุฃููุง ุชุชุญูู ุงููุณุคูููุฉ ุงููุชุนููุฉ ุจูุง ููู:</p>
    <ul>
        <li>ุฅุนุฏุงุฏ ูุนุฑุถ ุงูุจูุงูุงุช ุงููุงููุฉ ุจุดูู ุนุงุฏู ูููุง ููุนุงููุฑ ุงูุชูุงุฑูุฑ ุงููุงููุฉ ุงูุฏูููุฉ (IFRS)</li>
        <li>ุงูุถูุงุจุท ุงูุฏุงุฎููุฉ ุงูุถุฑูุฑูุฉ ูุฅุนุฏุงุฏ ุงูุจูุงูุงุช ุงููุงููุฉ ุงูุฎุงููุฉ ูู ุงูุฃุฎุทุงุก ุงูุฌููุฑูุฉ</li>
        <li>ุชุฒููุฏูุง ุจุฌููุน ุงููุนูููุงุช ูุงููุซุงุฆู ุงููุงุฒูุฉ ูููุฑุงุฌุนุฉ</li>
    </ul>

    <div class="section-title">ูููุฉ ุงูุฃุชุนุงุจ ุงูููููุฉ ูุทุฑููุฉ ุงูุณุฏุงุฏ:</div>
    
    <table>
        <tr>
            <th>ุงูุจูุงู</th>
            <th>ุงูุฃุชุนุงุจ</th>
            <th>ุงูุฏูุน</th>
        </tr>
        <tr>
            <td>ูุฑุงุฌุนุฉ ุงูุญุณุงุจุงุช ุงูุณูููุฉ ุงูููุชููุฉ ูู 31 ุฏูุณูุจุฑ ${year}ู</td>
            <td>${priceBeforeVAT.toFixed(0).toLocaleString()} ุฑูุงู</td>
            <td>${advancePercent}% ุนูุฏ ุงูุชุนุงูุฏ<br>${100 - advancePercent}% ุนูุฏ ุฅุตุฏุงุฑ ุงูุชูุฑูุฑ</td>
        </tr>
        <tr>
            <td>ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ 15% โ ุฑูู ุถุฑูุจู ูฃูกูกูฆูฃูฅูงูคูงูฉูููููฃ</td>
            <td>${vat.toFixed(0).toLocaleString()} ุฑูุงู</td>
            <td>${advancePercent}% ุนูุฏ ุงูุชุนุงูุฏ<br>${100 - advancePercent}% ุนูุฏ ุฅุตุฏุงุฑ ุงูุชูุฑูุฑ</td>
        </tr>
        <tr>
            <td><strong>ุงูุฅุฌูุงูู</strong></td>
            <td><strong>${totalPrice.toFixed(0).toLocaleString()} ุฑูุงู</strong></td>
            <td>${advancePercent}% ุนูุฏ ุงูุชุนุงูุฏ<br>${100 - advancePercent}% ุนูุฏ ุฅุตุฏุงุฑ ุงูุชูุฑูุฑ</td>
        </tr>
    </table>

    <p>ูุชู ุงูุณุฏุงุฏ ูู ุฎูุงู ุดูู ูุฃูุฑ (ุดุฑูุฉ ุนูู ููุฏ ูุณุนูุฏ ูุญุงุณุจูู ููุฑุงุฌุนูู ูุงูููููู) ุฃู ุชุญููู ูุตุฑูู ุญุณุจ ุงูุจูุงูุงุช ุงูุชุงููุฉ:</p>

    <table>
        <tr>
            <td><strong>ุฅุณู ุงููุณุชููุฏ</strong></td>
            <td>ุดุฑูุฉ ุนูู ููุฏ ูุณุนูุฏ ูุญุงุณุจูู ููุฑุงุฌุนูู ูุงูููููู</td>
        </tr>
        <tr>
            <td><strong>ุฅุณู ุงูุจูู</strong></td>
            <td>ุจูู ุงูุฑูุงุถ</td>
        </tr>
        <tr>
            <td><strong>ุฑูู ุงูุญุณุงุจ</strong></td>
            <td>2641457329940</td>
        </tr>
        <tr>
            <td><strong>ุฑูู ุงูุขูุจุงู</strong></td>
            <td>SA 8720000002641457329940</td>
        </tr>
    </table>

    <div class="section-title">ุชูุฑูุฑ ูุฑุงุฌุน ุงูุญุณุงุจุงุช:</div>
    <p>ุฅุฐุง ุชููููุง ุฃุฏูุฉ ูุฑุงุฌุนุฉ ูุงููุฉ ูููุงุณุจุฉ ูุฏุนู ูู ุฌุงูุจ ูู ุฌูุงูุจ ุงูุฃููุฑ ุฐุงุช ุงูุฃูููุฉ ุงูุฎุงุตุฉ ุจุงููุฑุงุฌุนุฉุ ูุณูููู ุดูู ููุญุชูู ุชูุฑูุฑ ุงููุฑุงุฌุนุฉ ุงูุฎุงุต ุจูุง ุนุจุงุฑุฉ ุนู ุฑุฃู ุบูุฑ ูุนุฏู.</p>

    <p style="margin-top: 30px;">ุฅููุง ููุฏุฑ ููุญูุง ุงููุฑุตุฉ ูุชูุฏูู ุฎุฏูุงุชูุง ุงูููููุฉ ููู ุจุตูุฉ ูุฑุงุฌุน ุญุณุงุจุงุช ุฎุงุฑุฌู ูุณุชูู ููุชุทูุน ุฅูู ุงูุชุนุงูู ุงููุงูู ูููู ููู ููุธูููู.</p>

    <p style="text-align: center; margin: 30px 0;"><strong>ูุชูุถููุง ุจูุจูู ูุงุฆู ุงูุดูุฑ ูุงูุชูุฏูุฑ</strong></p>

    <table class="signature-table">
        <tr>
            <td style="width: 50%; text-align: center;">
                <p><strong>ุดุฑูุฉ ุนูู ููุฏ ูุณุนูุฏ</strong></p>
                <p>ูุญุงุณุจูู ููุฑุงุฌุนูู ูุงูููููู</p>
                <p style="margin-top: 20px;">ุงูุฅุณู: ุนูู ููุฏ ูุณุนูุฏ</p>
                <p>ุงูููุตุจ: ุงูุดุฑูู ุงููุฏูุฑ</p>
                <p>ุงูุชุงุฑูุฎ: ${today}</p>
                <p>ุงูุชูููุน: _______________</p>
            </td>
            <td style="width: 50%; text-align: center;">
                <p><strong>${clientName}</strong></p>
                <p>ุณุฌู ุชุฌุงุฑู ุฑูู ${crNumber}</p>
                <p style="margin-top: 20px;">ุงูุฅุณู: ${clientRep}</p>
                <p>ุงูููุตุจ: ${clientPosition}</p>
                <p>ุงูุชุงุฑูุฎ: ${today}</p>
                <p>ุงูุชูููุน: _______________</p>
            </td>
        </tr>
    </table>
</body>
</html>
            `;

            // Create blob and download
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ุฎุทุงุจ_ุงุฑุชุจุงุท_${clientName}_${year}.html`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            closeModal('letterModal');
            alert('โ ุชู ุชุตุฏูุฑ ุงูุฎุทุงุจ!\n\nุงูุฎุทูุงุช:\n1. ุงูุชุญ ุงูููู ูู Word\n2. ุงุถุจุท ุงูุชูุณูู ุฅุฐุง ูุฒู\n3. ุงุญูุธู ูู PDF');
        }

        function generateLetter() {
            const clientName = document.getElementById('clientName').value;
            const clientRep = document.getElementById('clientRep').value;
            const clientPosition = document.getElementById('clientPosition').value;
            const crNumber = document.getElementById('crNumber').value;
            const clientAddress = document.getElementById('clientAddress').value;
            const year = document.getElementById('year').value;
            const advancePercent = parseFloat(document.getElementById('advancePercent').value) || 50;

            if (!clientName || !clientRep || !crNumber) {
                alert('ูุฑุฌู ุฅุฏุฎุงู ุฌููุน ุงูุจูุงูุงุช ุงููุทููุจุฉ');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const priceBeforeVAT = currentProposal.priceBeforeVAT || 0;
            const vat = priceBeforeVAT * 0.15;
            const totalPrice = priceBeforeVAT + vat;
            const advance = totalPrice * (advancePercent / 100);
            const remaining = totalPrice - advance;
            const today = new Date().toLocaleDateString('ar-SA');

            // Header - English
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text('Engagement Letter', 105, 20, { align: 'center' });
            doc.text('ุฎุทุงุจ ุงูุงุฑุชุจุงุท', 105, 30, { align: 'center' });
            
            // Date
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text(today, 170, 45);

            // Company info
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Ali Fahd Masoud CPA', 105, 60, { align: 'center' });
            doc.text('ุดุฑูุฉ ุนูู ููุฏ ูุณุนูุฏ ูุญุงุณุจูู ููุฑุงุฌุนูู ูุงูููููู', 105, 68, { align: 'center' });

            // Client section
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            doc.text('To: ' + clientName, 20, 85);
            doc.text('CR: ' + crNumber, 20, 92);
            doc.text('Address: ' + clientAddress, 20, 99);

            // Service description
            doc.setFont('helvetica', 'bold');
            doc.text(`Audit Services for the year ended December 31, ${year}`, 20, 115);
            
            doc.setFont('helvetica', 'normal');
            doc.text('We will conduct an audit of the financial statements including:', 20, 125);
            doc.text('โข Statement of Financial Position', 25, 133);
            doc.text('โข Statement of Profit or Loss and Comprehensive Income', 25, 140);
            doc.text('โข Statement of Cash Flows', 25, 147);

            // Fees table
            doc.setFont('helvetica', 'bold');
            doc.text('Professional Fees:', 20, 165);
            
            doc.autoTable({
                startY: 172,
                head: [['Description', 'Amount (SAR)']],
                body: [
                    ['Audit Services (before VAT)', priceBeforeVAT.toFixed(0).toLocaleString()],
                    ['VAT 15%', vat.toFixed(0).toLocaleString()],
                    ['Total', totalPrice.toFixed(0).toLocaleString()],
                    ['Advance Payment (' + advancePercent + '%)', advance.toFixed(0).toLocaleString()],
                    ['Upon Report Issuance', remaining.toFixed(0).toLocaleString()]
                ],
                theme: 'grid',
                styles: { font: 'helvetica', fontSize: 10 },
                headStyles: { fillColor: [200, 159, 101], textColor: [0, 0, 0], fontStyle: 'bold' },
                columnStyles: {
                    0: { halign: 'left' },
                    1: { halign: 'right' }
                }
            });

            // Signatures
            const finalY = doc.lastAutoTable.finalY + 25;
            doc.setFont('helvetica', 'bold');
            doc.text('Ali Fahd Masoud CPA', 130, finalY);
            doc.text(clientName, 30, finalY);
            
            doc.setFont('helvetica', 'normal');
            doc.text('Auditor', 130, finalY + 7);
            doc.text('Representative: ' + clientRep, 30, finalY + 7);
            doc.text('Position: ' + clientPosition, 30, finalY + 14);

            doc.text('Signature: _______________', 130, finalY + 25);
            doc.text('Signature: _______________', 30, finalY + 25);

            doc.text('Date: ' + today, 130, finalY + 32);
            doc.text('Date: _______________', 30, finalY + 32);

            doc.save(`Engagement_Letter_${clientName}_${year}.pdf`);
            closeModal('letterModal');
            alert('ุชู ุฅุตุฏุงุฑ ุฎุทุงุจ ุงูุงุฑุชุจุงุท ุจูุฌุงุญ!');
        }

        function loadCostsForm() {
            ['annualHours','maintenance','utilities','communications','software','adminSalaries','supplies','monthlyMisc',
             'rent','insurance','depreciation','marketing','socpa','training','generalSoftware','annualMisc',
             'partnerRate','supervisorRate','staffRate','profitMargin','commissionRate'].forEach(key => {
                const el = document.getElementById(key);
                if (el && costs[key] !== undefined) el.value = costs[key];
            });
            calcCostSummary();
        }

        function saveCosts() {
            costs = {
                annualHours: parseFloat(document.getElementById('annualHours').value),
                maintenance: parseFloat(document.getElementById('maintenance').value) || 0,
                utilities: parseFloat(document.getElementById('utilities').value) || 0,
                communications: parseFloat(document.getElementById('communications').value) || 0,
                software: parseFloat(document.getElementById('software').value) || 0,
                adminSalaries: parseFloat(document.getElementById('adminSalaries').value) || 0,
                supplies: parseFloat(document.getElementById('supplies').value) || 0,
                monthlyMisc: parseFloat(document.getElementById('monthlyMisc').value) || 0,
                rent: parseFloat(document.getElementById('rent').value) || 0,
                insurance: parseFloat(document.getElementById('insurance').value) || 0,
                depreciation: parseFloat(document.getElementById('depreciation').value) || 0,
                marketing: parseFloat(document.getElementById('marketing').value) || 0,
                socpa: parseFloat(document.getElementById('socpa').value) || 0,
                training: parseFloat(document.getElementById('training').value) || 0,
                generalSoftware: parseFloat(document.getElementById('generalSoftware').value) || 0,
                annualMisc: parseFloat(document.getElementById('annualMisc').value) || 0,
                partnerRate: parseFloat(document.getElementById('partnerRate').value),
                supervisorRate: parseFloat(document.getElementById('supervisorRate').value),
                staffRate: parseFloat(document.getElementById('staffRate').value),
                profitMargin: parseFloat(document.getElementById('profitMargin').value),
                commissionRate: parseFloat(document.getElementById('commissionRate').value) || 0
            };
            localStorage.setItem('costs', JSON.stringify(costs));
            alert('ุชู ุญูุธ ุงูุชูุงููู');
            calcCostSummary();
        }

        function calcCostSummary() {
            const monthly = ['maintenance','utilities','communications','software','adminSalaries','supplies','monthlyMisc']
                .reduce((sum, id) => sum + (parseFloat(document.getElementById(id)?.value) || 0), 0) * 12;
            const annual = ['rent','insurance','depreciation','marketing','socpa','training','generalSoftware','annualMisc']
                .reduce((sum, id) => sum + (parseFloat(document.getElementById(id)?.value) || 0), 0);
            const total = monthly + annual;
            const hours = parseFloat(document.getElementById('annualHours')?.value) || 10000;
            const perHour = total / hours;
            const commissionRate = parseFloat(document.getElementById('commissionRate')?.value) || 0;

            if (document.getElementById('annualTotal'))
                document.getElementById('annualTotal').textContent = total.toLocaleString() + ' ุฑูุงู';
            if (document.getElementById('perHour'))
                document.getElementById('perHour').textContent = perHour.toFixed(2) + ' ุฑูุงู';
            if (document.getElementById('commissionDisplay'))
                document.getElementById('commissionDisplay').textContent = commissionRate + '%';
        }

        function loadPlanningForm() {
            // Copy current values to future fields
            document.getElementById('futureHours').value = costs.annualHours || 10000;
            document.getElementById('futureRent').value = costs.rent || 0;
            document.getElementById('futureMaintenance').value = costs.maintenance || 0;
            document.getElementById('futureUtilities').value = costs.utilities || 0;
            document.getElementById('futureAdmin').value = costs.adminSalaries || 0;
            document.getElementById('futureInsurance').value = costs.insurance || 0;
            document.getElementById('futureDepreciation').value = costs.depreciation || 0;
            document.getElementById('futureMarketing').value = costs.marketing || 0;
            document.getElementById('futureTraining').value = costs.training || 0;
            document.getElementById('futurePartnerRate').value = costs.partnerRate || 800;
            document.getElementById('futureSupervisorRate').value = costs.supervisorRate || 400;
            document.getElementById('futureStaffRate').value = costs.staffRate || 150;
        }

        function comparePlanning() {
            // Current scenario
            const currentMonthly = (costs.rent + costs.maintenance + costs.utilities + 
                                   costs.adminSalaries) * 12;
            const currentAnnual = costs.insurance + costs.depreciation + costs.marketing + costs.training;
            const currentTotal = currentMonthly + currentAnnual;
            const currentHours = costs.annualHours || 10000;
            const currentOverhead = currentTotal / currentHours;
            const currentAvgSalary = ((costs.partnerRate || 800) + (costs.supervisorRate || 400) + 
                                     (costs.staffRate || 150)) / 3;
            const currentFullCost = currentAvgSalary + currentOverhead;
            const currentPrice = currentFullCost * (1 + (costs.profitMargin || 30) / 100);

            // Future scenario
            const futureMonthly = (parseFloat(document.getElementById('futureRent').value) +
                                  parseFloat(document.getElementById('futureMaintenance').value) +
                                  parseFloat(document.getElementById('futureUtilities').value) +
                                  parseFloat(document.getElementById('futureAdmin').value)) * 12;
            const futureAnnual = parseFloat(document.getElementById('futureInsurance').value) +
                                parseFloat(document.getElementById('futureDepreciation').value) +
                                parseFloat(document.getElementById('futureMarketing').value) +
                                parseFloat(document.getElementById('futureTraining').value);
            const futureTotal = futureMonthly + futureAnnual;
            const futureHours = parseFloat(document.getElementById('futureHours').value) || 10000;
            const futureOverhead = futureTotal / futureHours;
            const futureAvgSalary = (parseFloat(document.getElementById('futurePartnerRate').value) +
                                    parseFloat(document.getElementById('futureSupervisorRate').value) +
                                    parseFloat(document.getElementById('futureStaffRate').value)) / 3;
            const futureFullCost = futureAvgSalary + futureOverhead;
            const futurePrice = futureFullCost * (1 + (costs.profitMargin || 30) / 100);

            // Calculate differences
            const costDiff = ((futureTotal - currentTotal) / currentTotal * 100).toFixed(1);
            const perHourDiff = ((futureOverhead - currentOverhead) / currentOverhead * 100).toFixed(1);
            const fullCostDiff = ((futureFullCost - currentFullCost) / currentFullCost * 100).toFixed(1);
            const priceDiff = ((futurePrice - currentPrice) / currentPrice * 100).toFixed(1);

            // Display comparison
            document.getElementById('currentAnnualCost').textContent = currentTotal.toLocaleString() + ' ุฑูุงู';
            document.getElementById('futureAnnualCost').textContent = futureTotal.toLocaleString() + ' ุฑูุงู';
            document.getElementById('costDiff').innerHTML = `<span class="${costDiff > 0 ? 'increase' : 'decrease'}">${costDiff}%</span>`;

            document.getElementById('currentPerHour').textContent = currentOverhead.toFixed(2) + ' ุฑูุงู';
            document.getElementById('futurePerHour').textContent = futureOverhead.toFixed(2) + ' ุฑูุงู';
            document.getElementById('perHourDiff').innerHTML = `<span class="${perHourDiff > 0 ? 'increase' : 'decrease'}">${perHourDiff}%</span>`;

            document.getElementById('currentFullCost').textContent = currentFullCost.toFixed(0) + ' ุฑูุงู';
            document.getElementById('futureFullCost').textContent = futureFullCost.toFixed(0) + ' ุฑูุงู';
            document.getElementById('fullCostDiff').innerHTML = `<span class="${fullCostDiff > 0 ? 'increase' : 'decrease'}">${fullCostDiff}%</span>`;

            document.getElementById('currentClientPrice').textContent = currentPrice.toFixed(0) + ' ุฑูุงู';
            document.getElementById('futureClientPrice').textContent = futurePrice.toFixed(0) + ' ุฑูุงู';
            document.getElementById('clientPriceDiff').innerHTML = `<span class="${priceDiff > 0 ? 'increase' : 'decrease'}">${priceDiff}%</span>`;

            // Recommendations
            let recommendations = '<ul style="padding-right: 20px;">';
            
            if (parseFloat(priceDiff) > 20) {
                recommendations += '<li>โ๏ธ ุงูุฒูุงุฏุฉ ูู ุงูุณุนุฑ ุฃูุซุฑ ูู 20% - ูุฏ ุชุคุซุฑ ุนูู ุงููุฏุฑุฉ ุงูุชูุงูุณูุฉ</li>';
                recommendations += '<li>๐ก ููุฑ ูู ุฒูุงุฏุฉ ุงูุณุงุนุงุช ุงููุงุจูุฉ ููููุชุฑุฉ ูุชุฎููู ุงูุชุฃุซูุฑ</li>';
            } else if (parseFloat(priceDiff) > 10) {
                recommendations += '<li>โ ุงูุฒูุงุฏุฉ ูุนูููุฉ ููููู ุชุจุฑูุฑูุง ุจุงูุชูุณุน ูุงูุชุญุณููุงุช</li>';
            } else {
                recommendations += '<li>โ ุงูุชุฃุซูุฑ ุนูู ุงูุณุนุฑ ููุฎูุถ ูููุจูู</li>';
            }

            const clientsNeeded = Math.ceil(futureTotal / futurePrice);
            recommendations += `<li>๐ ุชุญุชุงุฌ ุฅูู ุญูุงูู ${clientsNeeded} ุนููู ุณูููุงู ูุชุบุทูุฉ ุงูุชูุงููู ุงูุฌุฏูุฏุฉ</li>`;

            const hoursNeeded = Math.ceil(futureTotal / futureFullCost);
            recommendations += `<li>โฑ๏ธ ุชุญุชุงุฌ ุฅูู ${hoursNeeded} ุณุงุนุฉ ุนูู ูุจุงุดุฑ ุณูููุงู ูุชุญููู ููุทุฉ ุงูุชุนุงุฏู</li>`;

            if (futureHours > currentHours) {
                const increasePercent = ((futureHours - currentHours) / currentHours * 100).toFixed(0);
                recommendations += `<li>๐ ุฒูุงุฏุฉ ุงูุณุงุนุงุช ุงููุชุงุญุฉ ุจูุณุจุฉ ${increasePercent}% - ููุชุงุฒ ููููู!</li>`;
            }

            recommendations += '</ul>';
            document.getElementById('recommendations').innerHTML = recommendations;

            document.getElementById('planningResult').classList.remove('hidden');
        }

        function loadClients() {
            if (clients.length === 0) {
                document.getElementById('clientsList').innerHTML = '<p style="text-align:center;color:var(--primary);padding:40px;">ูุง ุชูุฌุฏ ุจูุงูุงุช ุชุงุฑูุฎูุฉ ุจุนุฏ. ุงุจุฏุฃ ุจุฅุถุงูุฉ ุนููุงุก ูู ุญุงุณุจุฉ ุงูุชุณุนูุฑ!</p>';
                return;
            }

            // Update stats
            document.getElementById('totalClients').textContent = clients.length;
            const avgHours = (clients.reduce((sum, c) => sum + (c.totalHours || 0), 0) / clients.length).toFixed(1);
            const avgPrice = Math.round(clients.reduce((sum, c) => sum + (c.price || 0), 0) / clients.length);
            document.getElementById('avgHours').textContent = avgHours;
            document.getElementById('avgPrice').textContent = avgPrice.toLocaleString() + ' ุฑูุงู';

            // Populate year filter
            const years = [...new Set(clients.map(c => c.year))].sort().reverse();
            const yearFilter = document.getElementById('filterYear');
            yearFilter.innerHTML = '<option value="">ุงููู</option>' + 
                years.map(y => `<option value="${y}">${y}</option>`).join('');

            // Display table
            let html = `
                <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>ุงูุนููู</th>
                            <th>ุงูุณูุฉ</th>
                            <th>ุงููุดุงุท</th>
                            <th>ุงูุฅูุฑุงุฏุงุช (ู.ุฑ)</th>
                            <th>ุงูุฃุตูู (ู.ุฑ)</th>
                            <th>ุณุงุนุงุช ุงูุดุฑูู</th>
                            <th>ุณุงุนุงุช ุงูุฅุดุฑุงู</th>
                            <th>ุณุงุนุงุช ุงูุนูู</th>
                            <th>ุฅุฌูุงูู ุงูุณุงุนุงุช</th>
                            <th>ุงูุณุนุฑ (ุฑูุงู)</th>
                            <th>ุงูุชุงุฑูุฎ</th>
                            ${isAdmin ? '<th>ุงูุฅุฌุฑุงุกุงุช</th>' : ''}
                        </tr>
                    </thead>
                    <tbody id="clientsTableBody">
            `;
            
            clients.forEach((c, index) => {
                const date = new Date(c.id).toLocaleDateString('ar-SA');
                html += `
                    <tr class="client-row" 
                        data-name="${c.name}" 
                        data-activity="${c.activity}" 
                        data-year="${c.year}">
                        <td><strong>${c.name}</strong></td>
                        <td>${c.year}</td>
                        <td>${c.activity}</td>
                        <td>${c.revenue || 0}</td>
                        <td>${c.assets || 0}</td>
                        <td>${c.partnerHours || 0}</td>
                        <td>${c.supervisorHours || 0}</td>
                        <td>${c.staffHours || 0}</td>
                        <td><strong>${c.totalHours || 0}</strong></td>
                        <td><strong>${(c.price || 0).toLocaleString()}</strong></td>
                        <td style="font-size: 0.9em; color: #B8B8B8;">${date}</td>
                        ${isAdmin ? `<td>
                            <button onclick="editClient(${index})" style="padding: 8px 15px; font-size: 0.9em; margin: 2px;">โ๏ธ ุชุนุฏูู</button>
                            <button onclick="deleteClient(${index})" class="secondary" style="padding: 8px 15px; font-size: 0.9em; margin: 2px;">๐๏ธ ุญุฐู</button>
                        </td>` : ''}
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('clientsList').innerHTML = html;
        }

        function editClient(index) {
            const client = clients[index];
            if (!client) return;

            const newName = prompt('ุงุณู ุงูุนููู:', client.name);
            if (newName === null) return;

            const newYear = prompt('ุงูุณูุฉ:', client.year);
            if (newYear === null) return;

            const newRevenue = prompt('ุงูุฅูุฑุงุฏุงุช (ููููู ุฑูุงู):', client.revenue);
            if (newRevenue === null) return;

            const newAssets = prompt('ุงูุฃุตูู (ููููู ุฑูุงู):', client.assets);
            if (newAssets === null) return;

            const newPartnerHours = prompt('ุณุงุนุงุช ุงูุดุฑูู:', client.partnerHours);
            if (newPartnerHours === null) return;

            const newSupervisorHours = prompt('ุณุงุนุงุช ุงูุฅุดุฑุงู:', client.supervisorHours);
            if (newSupervisorHours === null) return;

            const newStaffHours = prompt('ุณุงุนุงุช ุงูุนูู:', client.staffHours);
            if (newStaffHours === null) return;

            const newPrice = prompt('ุงูุณุนุฑ ุงูููุงุฆู (ุฑูุงู):', client.price);
            if (newPrice === null) return;

            // Update client
            clients[index].name = newName;
            clients[index].year = newYear;
            clients[index].revenue = parseFloat(newRevenue) || 0;
            clients[index].assets = parseFloat(newAssets) || 0;
            clients[index].partnerHours = parseFloat(newPartnerHours) || 0;
            clients[index].supervisorHours = parseFloat(newSupervisorHours) || 0;
            clients[index].staffHours = parseFloat(newStaffHours) || 0;
            clients[index].totalHours = clients[index].partnerHours + clients[index].supervisorHours + clients[index].staffHours;
            clients[index].price = parseFloat(newPrice) || 0;

            localStorage.setItem('clients', JSON.stringify(clients));
            alert('โ ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูุนููู');
            loadClients();
        }

        function deleteClient(index) {
            const client = clients[index];
            if (!client) return;

            if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูุนููู "${client.name}" ูู ุงูุจูุงูุงุช ุงูุชุงุฑูุฎูุฉุ\n\nูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู.`)) {
                clients.splice(index, 1);
                localStorage.setItem('clients', JSON.stringify(clients));
                alert('โ ุชู ุญุฐู ุงูุนููู ูู ุงูุจูุงูุงุช ุงูุชุงุฑูุฎูุฉ');
                loadClients();
            }
        }

        function filterClients() {
            const searchTerm = document.getElementById('searchClients').value.toLowerCase();
            const activityFilter = document.getElementById('filterActivity').value;
            const yearFilter = document.getElementById('filterYear').value;

            const rows = document.querySelectorAll('.client-row');
            let visibleCount = 0;

            rows.forEach(row => {
                const name = row.dataset.name.toLowerCase();
                const activity = row.dataset.activity;
                const year = row.dataset.year;

                const matchSearch = name.includes(searchTerm) || activity.includes(searchTerm);
                const matchActivity = !activityFilter || activity === activityFilter;
                const matchYear = !yearFilter || year === yearFilter;

                if (matchSearch && matchActivity && matchYear) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Update total count
            if (visibleCount !== clients.length) {
                document.getElementById('totalClients').textContent = `${visibleCount} ูู ${clients.length}`;
            } else {
                document.getElementById('totalClients').textContent = clients.length;
            }
        }

        function exportClients() {
            if (clients.length === 0) {
                alert('ูุง ุชูุฌุฏ ุจูุงูุงุช ูุชุตุฏูุฑูุง');
                return;
            }

            // Create CSV content
            const headers = ['ุงูุนููู', 'ุงูุณูุฉ', 'ุงููุดุงุท', 'ุงูุฅูุฑุงุฏุงุช', 'ุงูุฃุตูู', 'ุณุงุนุงุช ุงูุดุฑูู', 'ุณุงุนุงุช ุงูุฅุดุฑุงู', 'ุณุงุนุงุช ุงูุนูู', 'ุฅุฌูุงูู ุงูุณุงุนุงุช', 'ุงูุณุนุฑ', 'ุงูุชุงุฑูุฎ'];
            
            let csv = '\uFEFF' + headers.join(',') + '\n'; // BOM for Excel Arabic support
            
            clients.forEach(c => {
                const date = new Date(c.id).toLocaleDateString('ar-SA');
                const row = [
                    c.name,
                    c.year,
                    c.activity,
                    c.revenue || 0,
                    c.assets || 0,
                    c.partnerHours || 0,
                    c.supervisorHours || 0,
                    c.staffHours || 0,
                    c.totalHours || 0,
                    c.price || 0,
                    date
                ];
                csv += row.join(',') + '\n';
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ุงูุนููุงุก_ุงูุชุงุฑูุฎููู_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Backup Functions
        function exportData() {
            const backup = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                costs: costs,
                clients: clients
            };

            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ูุณุฎุฉ_ุงุญุชูุงุทูุฉ_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('โ ุชู ุชุตุฏูุฑ ุงูุจูุงูุงุช ุจูุฌุงุญ!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (!backup.version || !backup.costs || !backup.clients) {
                        throw new Error('ููู ุบูุฑ ุตุงูุญ');
                    }

                    if (confirm('โ๏ธ ูู ุฃูุช ูุชุฃูุฏุ ุณูุชู ุงุณุชุจุฏุงู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ!')) {
                        costs = backup.costs;
                        clients = backup.clients;
                        
                        localStorage.setItem('costs', JSON.stringify(costs));
                        localStorage.setItem('clients', JSON.stringify(clients));
                        
                        loadCostsForm();
                        loadClients();
                        
                        alert('โ ุชู ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ุจูุฌุงุญ!');
                    }
                } catch (error) {
                    alert('โ ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset input
            event.target.value = '';
        }

        // Load costs on page load
        if (Object.keys(costs).length > 0) {
            loadCostsForm();
        } else {
            // Set default commission display
            if (document.getElementById('commissionDisplay')) {
                document.getElementById('commissionDisplay').textContent = '0%';
            }
        }
    </script>
</body>
</html>
