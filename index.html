<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³Ø¹ÙŠØ± - Ø´Ø±ÙƒØ© Ø¹Ù„ÙŠ ÙÙ‡Ø¯ Ù…Ø³Ø¹ÙˆØ¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #C89F65;
            --secondary: #D4AF6E;
            --dark: #2C3338;
            --darker: #1F2327;
            --card: #3A4048;
            --accent: #F4B942;
            --border: #4A5058;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, var(--darker), var(--dark));
            color: #E8E8E8;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        header {
            background: var(--card);
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 2px solid var(--primary);
            text-align: center;
        }
        h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .subtitle { color: var(--secondary); font-size: 1.2em; }
        .admin-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--darker);
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(200,159,101,0.4);
        }
        .admin-btn:hover { transform: translateY(-3px); }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--card);
            padding: 40px;
            border-radius: 20px;
            border: 2px solid var(--primary);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .tab {
            flex: 1;
            min-width: 150px;
            padding: 18px 20px;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.95em;
        }
        .tab:hover { border-color: var(--primary); transform: translateY(-2px); }
        .tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--darker);
            border-color: var(--accent);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card {
            background: var(--card);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
        }
        .card-header {
            font-size: 1.8em;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        label {
            color: var(--secondary);
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.95em;
        }
        input, select, textarea {
            padding: 14px;
            background: var(--darker);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: white;
            font-size: 1em;
            font-family: 'Cairo', sans-serif;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        button {
            padding: 16px 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--darker);
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Cairo', sans-serif;
        }
        button:hover { transform: translateY(-3px); }
        button.secondary {
            background: var(--dark);
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        .section-title {
            color: var(--primary);
            font-size: 1.3em;
            margin: 25px 0 15px;
            padding-right: 15px;
            border-right: 4px solid var(--primary);
        }
        .result-box {
            background: linear-gradient(135deg, rgba(200,159,101,0.15), rgba(212,175,110,0.15));
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
            border: 2px solid var(--primary);
        }
        .result-title {
            color: var(--accent);
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 15px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .stat {
            background: var(--darker);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        .stat-label {
            color: #B8B8B8;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        .stat-value {
            color: var(--primary);
            font-size: 1.6em;
            font-weight: 700;
        }
        .hours-adjust {
            background: var(--darker);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid var(--accent);
        }
        .hours-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
        }
        .hours-row label { flex: 1; margin: 0; }
        .hours-row input { flex: 2; }
        .hours-row .suggested {
            flex: 1;
            color: var(--accent);
            font-size: 0.9em;
        }
        .hidden { display: none !important; }
        .admin-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--primary);
            color: var(--darker);
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 700;
            z-index: 1000;
        }
        .comparison-table {
            width: 100%;
            margin-top: 20px;
        }
        .comparison-table td {
            padding: 15px;
            border: 1px solid var(--border);
        }
        .comparison-table tr:first-child td {
            background: var(--primary);
            color: var(--darker);
            font-weight: 700;
        }
        .increase { color: #FF6B6B; }
        .decrease { color: #51CF66; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--darker);
            border-radius: 10px;
            overflow: hidden;
        }
        th {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--darker);
            padding: 15px;
            text-align: right;
            font-weight: 700;
        }
        td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            color: #E8E8E8;
        }
        tr:hover { background: var(--card); }
        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            .form-grid { grid-template-columns: 1fr; }
            .tabs { flex-direction: column; }
            .tab { min-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>âš–ï¸ Ù†Ø¸Ø§Ù… ØªØ³Ø¹ÙŠØ± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© âš–ï¸</h1>
            <p class="subtitle">Ø´Ø±ÙƒØ© Ø¹Ù„ÙŠ ÙÙ‡Ø¯ Ù…Ø³Ø¹ÙˆØ¯ Ù…Ø­Ø§Ø³Ø¨ÙˆÙ† ÙˆÙ…Ø±Ø§Ø¬Ø¹ÙˆÙ† Ù‚Ø§Ù†ÙˆÙ†ÙŠÙˆÙ†</p>
        </header>

        <!-- Admin Modal -->
        <div id="authModal" class="modal">
            <div class="modal-content">
                <h2 class="card-header">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</h2>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                    <input type="text" id="adminUser">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="adminPass">
                </div>
                <button onclick="login()" style="width: 100%; margin-bottom: 10px;">Ø¯Ø®ÙˆÙ„</button>
                <button class="secondary" onclick="closeModal('authModal')" style="width: 100%;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>

        <!-- Engagement Letter Modal -->
        <div id="letterModal" class="modal">
            <div class="modal-content">
                <h2 class="card-header">Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø·Ø§Ø¨ Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·</h2>
                <div class="form-grid" style="grid-template-columns: 1fr;">
                    <div class="form-group">
                        <label>Ø§Ø³Ù… Ù…Ù…Ø«Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                        <input type="text" id="clientRep">
                    </div>
                    <div class="form-group">
                        <label>Ù…Ù†ØµØ¨ Ø§Ù„Ù…Ù…Ø«Ù„</label>
                        <input type="text" id="clientPosition">
                    </div>
                    <div class="form-group">
                        <label>Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</label>
                        <input type="text" id="crNumber">
                    </div>
                    <div class="form-group">
                        <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ø±ÙƒØ©</label>
                        <input type="text" id="clientAddress">
                    </div>
                    <div class="form-group">
                        <label>ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="form-group">
                        <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ù‚Ø¯Ù… (%)</label>
                        <input type="number" id="advancePercent" value="50">
                    </div>
                </div>
                <button onclick="generateLetter()" style="width: 100%; margin-bottom: 10px;">ğŸ“„ Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø®Ø·Ø§Ø¨</button>
                <button class="secondary" onclick="closeModal('letterModal')" style="width: 100%;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>

        <div id="adminIndicator" class="admin-indicator hidden">
            ğŸ‘¨â€ğŸ’¼ Ø§Ù„Ù…Ø¯ÙŠØ±
            <button onclick="logout()" style="padding: 5px 15px; margin-right: 10px;">Ø®Ø±ÙˆØ¬</button>
        </div>

        <button class="admin-btn" onclick="showModal('authModal')">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</button>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('calc')">ğŸ§® Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ±</div>
            <div class="tab admin-only hidden" onclick="switchTab('planning')">ğŸ“Š Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ</div>
            <div class="tab admin-only hidden" onclick="switchTab('costs')">ğŸ’° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</div>
            <div class="tab admin-only hidden" onclick="switchTab('clients')">ğŸ“‹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
        </div>

        <!-- Calculator Tab -->
        <div id="calcTab" class="tab-content active">
            <div class="card">
                <h2 class="card-header">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ±</h2>
                
                <h3 class="section-title">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                        <input type="text" id="clientName">
                    </div>
                    <div class="form-group">
                        <label>Ø³Ù†Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</label>
                        <input type="number" id="year" value="2025">
                    </div>
                    <div class="form-group">
                        <label>Ø­Ø¬Ù… Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ù…Ù„ÙŠÙˆÙ† Ø±ÙŠØ§Ù„)</label>
                        <input type="number" id="revenue" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆÙ„ (Ù…Ù„ÙŠÙˆÙ† Ø±ÙŠØ§Ù„)</label>
                        <input type="number" id="assets" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ© (Ù…Ù„ÙŠÙˆÙ† Ø±ÙŠØ§Ù„)</label>
                        <input type="number" id="fixedAssets" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·</label>
                        <select id="activity">
                            <option value="ØªØ¬Ø§Ø±ÙŠ">ØªØ¬Ø§Ø±ÙŠ</option>
                            <option value="ØµÙ†Ø§Ø¹ÙŠ">ØµÙ†Ø§Ø¹ÙŠ</option>
                            <option value="Ø®Ø¯Ù…ÙŠ">Ø®Ø¯Ù…ÙŠ</option>
                            <option value="Ù…Ø§Ù„ÙŠ">Ù…Ø§Ù„ÙŠ</option>
                        </select>
                    </div>
                </div>

                <h3 class="section-title">Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„ØªØ¹Ù‚ÙŠØ¯</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø¯ÙŠÙ†ÙŠÙ† (Ù…Ù„ÙŠÙˆÙ† Ø±ÙŠØ§Ù„)</label>
                        <input type="number" id="receivables" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø¯Ø§Ø¦Ù†ÙŠÙ† (Ù…Ù„ÙŠÙˆÙ† Ø±ÙŠØ§Ù„)</label>
                        <input type="number" id="payables" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±ÙˆØ¹</label>
                        <input type="number" id="branches" value="1">
                    </div>
                    <div class="form-group">
                        <label>Ø¬ÙˆØ¯Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ</label>
                        <select id="systemQuality">
                            <option value="Ø¶Ø¹ÙŠÙ">Ø¶Ø¹ÙŠÙ</option>
                            <option value="Ù…ØªÙˆØ³Ø·">Ù…ØªÙˆØ³Ø·</option>
                            <option value="Ù…Ù…ØªØ§Ø²">Ù…Ù…ØªØ§Ø²</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©</label>
                        <select id="internalControl">
                            <option value="Ø¶Ø¹ÙŠÙ">Ø¶Ø¹ÙŠÙ</option>
                            <option value="Ù…ØªÙˆØ³Ø·">Ù…ØªÙˆØ³Ø·</option>
                            <option value="Ù‚ÙˆÙŠ">Ù‚ÙˆÙŠ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                        <select id="clientType">
                            <option value="Ø¬Ø¯ÙŠØ¯">Ø¬Ø¯ÙŠØ¯</option>
                            <option value="Ù…ØªÙƒØ±Ø±">Ù…ØªÙƒØ±Ø±</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ©</label>
                        <input type="number" id="bankAccounts" value="1">
                    </div>
                    <div class="form-group">
                        <label>Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¹Ù…Ù„Ø§Øª Ø£Ø¬Ù†Ø¨ÙŠØ©</label>
                        <select id="foreignCurrency">
                            <option value="Ù„Ø§">Ù„Ø§</option>
                            <option value="Ù†Ø¹Ù…">Ù†Ø¹Ù…</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ø£Ø·Ø±Ø§Ù Ø°Ø§Øª Ø¹Ù„Ø§Ù‚Ø©</label>
                        <select id="relatedParties">
                            <option value="Ù„Ø§">Ù„Ø§</option>
                            <option value="Ù†Ø¹Ù…">Ù†Ø¹Ù…</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ÙˆØ¬ÙˆØ¯ Ù…Ø®Ø²ÙˆÙ†</label>
                        <select id="inventory">
                            <option value="Ù„Ø§">Ù„Ø§</option>
                            <option value="Ù†Ø¹Ù…">Ù†Ø¹Ù…</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ù‚Ø±ÙˆØ¶ ÙˆØ§Ù„ØªÙ…ÙˆÙŠÙ„</label>
                        <select id="loans">
                            <option value="Ù„Ø§">Ù„Ø§</option>
                            <option value="Ù†Ø¹Ù…">Ù†Ø¹Ù…</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø®ØµØµØ§Øª ÙˆØ§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ§Øª</label>
                        <select id="provisions">
                            <option value="Ù„Ø§">Ù„Ø§</option>
                            <option value="Ù†Ø¹Ù…">Ù†Ø¹Ù…</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª (IFRS 16)</label>
                        <select id="leases">
                            <option value="Ù„Ø§">Ù„Ø§</option>
                            <option value="Ù†Ø¹Ù…">Ù†Ø¹Ù…</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù‚ÙˆØ¯ (IFRS 15)</label>
                        <select id="revenueContracts">
                            <option value="Ù„Ø§">Ù„Ø§</option>
                            <option value="Ù†Ø¹Ù…">Ù†Ø¹Ù…</option>
                        </select>
                    </div>
                </div>

                <button onclick="suggest()">ğŸ”® Ø§Ø­Ø³Ø¨ Ø§Ù„ØªØ³Ø¹ÙŠØ±</button>

                <div id="prediction"></div>

                <div id="hoursAdjust" class="hidden">
                    <div class="hours-adjust">
                        <h3 class="result-title">âš™ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</h3>
                        <p style="color: #B8B8B8; margin-bottom: 15px;">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§</p>
                        
                        <div class="hours-row">
                            <label>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø´Ø±ÙŠÙƒ:</label>
                            <input type="number" id="adjPartner" step="0.5">
                            <span class="suggested" id="sugPartner"></span>
                        </div>
                        
                        <div class="hours-row">
                            <label>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¥Ø´Ø±Ø§Ù:</label>
                            <input type="number" id="adjSupervisor" step="0.5">
                            <span class="suggested" id="sugSupervisor"></span>
                        </div>
                        
                        <div class="hours-row">
                            <label>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„:</label>
                            <input type="number" id="adjStaff" step="0.5">
                            <span class="suggested" id="sugStaff"></span>
                        </div>

                        <button onclick="calculate()">ğŸ”„ Ø§Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø±</button>
                    </div>
                </div>

                <div id="pricing" class="result-box hidden">
                    <div class="result-title">ğŸ’µ Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div>
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</div>
                            <div class="stat-value" id="totalHours">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­ (Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</div>
                            <div class="stat-value" id="totalPrice">0 Ø±ÙŠØ§Ù„</div>
                        </div>
                        <div class="stat admin-only hidden">
                            <div class="stat-label">Ø§Ù„ØªÙƒÙ„ÙØ©</div>
                            <div class="stat-value" id="totalCost">0 Ø±ÙŠØ§Ù„</div>
                        </div>
                        <div class="stat admin-only hidden">
                            <div class="stat-label">Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­</div>
                            <div class="stat-value" id="margin">0%</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button onclick="saveProposal()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ø±Ø¶</button>
                        <button class="secondary" onclick="showModal('letterModal')">ğŸ“„ Ø¥ØµØ¯Ø§Ø± Ø®Ø·Ø§Ø¨ Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Future Planning Tab -->
        <div id="planningTab" class="tab-content">
            <div class="card">
                <h2 class="card-header">Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ</h2>
                
                <h3 class="section-title">Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø³Ù†ÙˆÙŠØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©</label>
                        <input type="number" id="futureHours" value="10000">
                    </div>
                </div>

                <h3 class="section-title">Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…ÙƒØ§ØªØ¨</label>
                        <input type="number" id="futureRent" value="0">
                    </div>
                    <div class="form-group">
                        <label>ØµÙŠØ§Ù†Ø© ÙˆØªÙ†Ø¸ÙŠÙ</label>
                        <input type="number" id="futureMaintenance" value="0">
                    </div>
                    <div class="form-group">
                        <label>Ù…Ø±Ø§ÙÙ‚</label>
                        <input type="number" id="futureUtilities" value="0">
                    </div>
                    <div class="form-group">
                        <label>Ø±ÙˆØ§ØªØ¨ Ø¥Ø¯Ø§Ø±ÙŠØ©</label>
                        <input type="number" id="futureAdmin" value="0">
                    </div>
                </div>

                <h3 class="section-title">Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø³Ù†ÙˆÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>ØªØ£Ù…ÙŠÙ†Ø§Øª</label>
                        <input type="number" id="futureInsurance" value="0">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ù…Ø¹Ø¯Ø§Øª</label>
                        <input type="number" id="futureDepreciation" value="0">
                    </div>
                    <div class="form-group">
                        <label>ØªØ³ÙˆÙŠÙ‚</label>
                        <input type="number" id="futureMarketing" value="0">
                    </div>
                    <div class="form-group">
                        <label>ØªØ¯Ø±ÙŠØ¨</label>
                        <input type="number" id="futureTraining" value="0">
                    </div>
                </div>

                <h3 class="section-title">ØªÙƒÙ„ÙØ© Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Ø±Ø§ØªØ¨ Ø³Ø§Ø¹Ø© Ø§Ù„Ø´Ø±ÙŠÙƒ</label>
                        <input type="number" id="futurePartnerRate" value="800">
                    </div>
                    <div class="form-group">
                        <label>Ø±Ø§ØªØ¨ Ø³Ø§Ø¹Ø© Ø§Ù„Ø¥Ø´Ø±Ø§Ù</label>
                        <input type="number" id="futureSupervisorRate" value="400">
                    </div>
                    <div class="form-group">
                        <label>Ø±Ø§ØªØ¨ Ø³Ø§Ø¹Ø© Ø§Ù„Ø¹Ù…Ù„</label>
                        <input type="number" id="futureStaffRate" value="150">
                    </div>
                </div>

                <button onclick="comparePlanning()">ğŸ“Š Ù‚Ø§Ø±Ù† Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ</button>

                <div id="planningResult" class="hidden">
                    <div class="result-box">
                        <div class="result-title">ğŸ“ˆ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ØªØ®Ø·ÙŠØ·</div>
                        <table class="comparison-table">
                            <tr>
                                <td>Ø§Ù„Ø¨ÙŠØ§Ù†</td>
                                <td>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</td>
                                <td>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ</td>
                                <td>Ø§Ù„ÙØ±Ù‚</td>
                            </tr>
                            <tr>
                                <td>Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø³Ù†ÙˆÙŠØ©</td>
                                <td id="currentAnnualCost">0</td>
                                <td id="futureAnnualCost">0</td>
                                <td id="costDiff">0</td>
                            </tr>
                            <tr>
                                <td>Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„ÙƒÙ„ Ø³Ø§Ø¹Ø©</td>
                                <td id="currentPerHour">0</td>
                                <td id="futurePerHour">0</td>
                                <td id="perHourDiff">0</td>
                            </tr>
                            <tr>
                                <td>ØªÙƒÙ„ÙØ© Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</td>
                                <td id="currentFullCost">0</td>
                                <td id="futureFullCost">0</td>
                                <td id="fullCostDiff">0</td>
                            </tr>
                            <tr>
                                <td>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø¹Ù…ÙŠÙ„</td>
                                <td id="currentClientPrice">0</td>
                                <td id="futureClientPrice">0</td>
                                <td id="clientPriceDiff">0</td>
                            </tr>
                        </table>
                    </div>

                    <div class="result-box">
                        <div class="result-title">ğŸ’¡ Ø§Ù„ØªÙˆØµÙŠØ§Øª</div>
                        <div id="recommendations" style="line-height: 1.8;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Costs Tab -->
        <div id="costsTab" class="tab-content">
            <div class="card">
                <h2 class="card-header">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</h2>
                
                <h3 class="section-title">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø³Ù†ÙˆÙŠØ©</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø§Ù„Ø³Ù†ÙˆÙŠØ©</label>
                        <input type="number" id="annualHours" value="10000">
                    </div>
                </div>

                <h3 class="section-title">Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø´Ù‡Ø±ÙŠØ© (Ø±ÙŠØ§Ù„)</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…ÙƒØ§ØªØ¨</label>
                        <input type="number" id="rent" value="0">
                    </div>
                    <div class="form-group">
                        <label>ØµÙŠØ§Ù†Ø© ÙˆØªÙ†Ø¸ÙŠÙ</label>
                        <input type="number" id="maintenance" value="0">
                    </div>
                    <div class="form-group">
                        <label>Ù…Ø±Ø§ÙÙ‚</label>
                        <input type="number" id="utilities" value="0">
                    </div>
                    <div class="form-group">
                        <label>Ø¨Ø±Ù…Ø¬ÙŠØ§Øª Ø¹Ø§Ù…Ø©</label>
                        <input type="number" id="software" value="0">
                    </div>
                    <div class="form-group">
                        <label>Ø±ÙˆØ§ØªØ¨ Ø¥Ø¯Ø§Ø±ÙŠØ©</label>
                        <input type="number" id="adminSalaries" value="0">
                    </div>
                    <div class="form-group">
                        <label>Ù‚Ø±Ø·Ø§Ø³ÙŠØ©</label>
                        <input type="number" id="supplies" value="0">
                    </div>
                </div>

                <h3 class="section-title">Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø³Ù†ÙˆÙŠØ© (Ø±ÙŠØ§Ù„)</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>ØªØ£Ù…ÙŠÙ†Ø§Øª</label>
                        <input type="number" id="insurance" value="0">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ù…Ø¹Ø¯Ø§Øª</label>
                        <input type="number" id="depreciation" value="0">
                    </div>
                    <div class="form-group">
                        <label>ØªØ³ÙˆÙŠÙ‚</label>
                        <input type="number" id="marketing" value="0">
                    </div>
                    <div class="form-group">
                        <label>Ø±Ø³ÙˆÙ… SOCPA</label>
                        <input type="number" id="socpa" value="0">
                    </div>
                    <div class="form-group">
                        <label>ØªØ¯Ø±ÙŠØ¨ ÙˆØ´Ù‡Ø§Ø¯Ø§Øª</label>
                        <input type="number" id="training" value="0">
                    </div>
                </div>

                <h3 class="section-title">ØªÙƒÙ„ÙØ© Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø¨Ø§Ù„Ø³Ø§Ø¹Ø© (Ø±ÙŠØ§Ù„)</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Ø±Ø§ØªØ¨ Ø³Ø§Ø¹Ø© Ø§Ù„Ø´Ø±ÙŠÙƒ</label>
                        <input type="number" id="partnerRate" value="800">
                    </div>
                    <div class="form-group">
                        <label>Ø±Ø§ØªØ¨ Ø³Ø§Ø¹Ø© Ø§Ù„Ø¥Ø´Ø±Ø§Ù</label>
                        <input type="number" id="supervisorRate" value="400">
                    </div>
                    <div class="form-group">
                        <label>Ø±Ø§ØªØ¨ Ø³Ø§Ø¹Ø© Ø§Ù„Ø¹Ù…Ù„</label>
                        <input type="number" id="staffRate" value="150">
                    </div>
                </div>

                <h3 class="section-title">Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (%)</label>
                        <input type="number" id="profitMargin" value="30">
                    </div>
                </div>

                <div class="result-box">
                    <div class="result-title">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</div>
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-label">Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø³Ù†ÙˆÙŠØ©</div>
                            <div class="stat-value" id="annualTotal">0 Ø±ÙŠØ§Ù„</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„ÙƒÙ„ Ø³Ø§Ø¹Ø©</div>
                            <div class="stat-value" id="perHour">0 Ø±ÙŠØ§Ù„</div>
                        </div>
                    </div>
                </div>

                <button onclick="saveCosts()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</button>
            </div>
        </div>

        <!-- Clients Tab -->
        <div id="clientsTab" class="tab-content">
            <div class="card">
                <h2 class="card-header">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ù†ÙØ°ÙŠÙ†</h2>
                <div id="clientsList"></div>
            </div>
        </div>
    </div>

    <script>
        let isAdmin = false;
        let clients = JSON.parse(localStorage.getItem('clients') || '[]');
        let costs = JSON.parse(localStorage.getItem('costs') || '{}');
        let sugHours = {};
        let currentProposal = {};

        function showModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function login() {
            const u = document.getElementById('adminUser').value;
            const p = document.getElementById('adminPass').value;
            if (u === 'admin' && p === 'admin123') {
                isAdmin = true;
                document.getElementById('adminIndicator').classList.remove('hidden');
                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
                closeModal('authModal');
                alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
                loadClients();
            } else {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        }

        function logout() {
            isAdmin = false;
            document.getElementById('adminIndicator').classList.add('hidden');
            document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
            switchTab('calc');
        }

        function switchTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(name + 'Tab').classList.add('active');
            if (name === 'clients') loadClients();
            if (name === 'costs') loadCostsForm();
            if (name === 'planning') loadPlanningForm();
        }

        function suggest() {
            const rev = parseFloat(document.getElementById('revenue').value) || 0;
            const ast = parseFloat(document.getElementById('assets').value) || 0;
            const act = document.getElementById('activity').value;
            const fix = parseFloat(document.getElementById('fixedAssets').value) || 0;
            const rec = parseFloat(document.getElementById('receivables').value) || 0;
            const pay = parseFloat(document.getElementById('payables').value) || 0;

            if (rev === 0 || ast === 0) {
                alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø£ØµÙˆÙ„');
                return;
            }

            const similar = clients.filter(c => {
                const rd = Math.abs(c.revenue - rev) / rev;
                const ad = Math.abs(c.assets - ast) / ast;
                return c.activity === act && rd < 0.3 && ad < 0.3;
            });

            let p, s, st;
            if (similar.length === 0) {
                let base = 40;
                if (rev > 100) base += 30; else if (rev > 50) base += 20;
                if (ast > 200) base += 25; else if (ast > 100) base += 15;
                if (act === 'Ù…Ø§Ù„ÙŠ') base += 30; else if (act === 'ØµÙ†Ø§Ø¹ÙŠ') base += 20;
                if (fix > 50) base += 20; else if (fix > 20) base += 12;
                if (rec > 30) base += 15; else if (rec > 15) base += 10;
                if (pay > 30) base += 12; else if (pay > 15) base += 8;
                base += (parseInt(document.getElementById('branches').value) - 1) * 5;
                if (document.getElementById('systemQuality').value === 'Ø¶Ø¹ÙŠÙ') base += 20;
                if (document.getElementById('internalControl').value === 'Ø¶Ø¹ÙŠÙ') base += 15;
                if (document.getElementById('clientType').value === 'Ø¬Ø¯ÙŠØ¯') base += 15;
                base += (parseInt(document.getElementById('bankAccounts').value) - 1) * 3;
                if (document.getElementById('foreignCurrency').value === 'Ù†Ø¹Ù…') base += 10;
                if (document.getElementById('relatedParties').value === 'Ù†Ø¹Ù…') base += 12;
                if (document.getElementById('inventory').value === 'Ù†Ø¹Ù…') base += 15;
                if (document.getElementById('loans').value === 'Ù†Ø¹Ù…') base += 12;
                if (document.getElementById('provisions').value === 'Ù†Ø¹Ù…') base += 10;
                if (document.getElementById('leases').value === 'Ù†Ø¹Ù…') base += 18;
                if (document.getElementById('revenueContracts').value === 'Ù†Ø¹Ù…') base += 16;
                p = Math.round(base * 0.15);
                s = Math.round(base * 0.25);
                st = base - p - s;
                document.getElementById('prediction').innerHTML = `
                    <div class="result-box">
                        <div class="result-title">ğŸ”® Ø§Ù„ØªÙˆÙ‚Ø¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</div>
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-label">Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©</div>
                                <div class="stat-value">${base}</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const ap = similar.reduce((sum, c) => sum + c.partnerHours, 0) / similar.length;
                const as = similar.reduce((sum, c) => sum + c.supervisorHours, 0) / similar.length;
                const ast = similar.reduce((sum, c) => sum + c.staffHours, 0) / similar.length;
                p = Math.round(ap);
                s = Math.round(as);
                st = Math.round(ast);
                document.getElementById('prediction').innerHTML = `
                    <div class="result-box">
                        <div class="result-title">ğŸ¯ ØªÙˆÙ‚Ø¹ Ø°ÙƒÙŠ</div>
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-label">Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©</div>
                                <div class="stat-value">${p + s + st}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø¨Ù‡ÙŠÙ†</div>
                                <div class="stat-value">${similar.length}</div>
                            </div>
                        </div>
                        <p style="margin-top:15px;color:var(--secondary)">Ø´Ø±ÙŠÙƒ: ${p} | Ø¥Ø´Ø±Ø§Ù: ${s} | Ø¹Ù…Ù„: ${st}</p>
                    </div>
                `;
            }

            sugHours = { partner: p, supervisor: s, staff: st };
            document.getElementById('adjPartner').value = p;
            document.getElementById('adjSupervisor').value = s;
            document.getElementById('adjStaff').value = st;
            document.getElementById('sugPartner').textContent = `Ù…Ù‚ØªØ±Ø­: ${p}`;
            document.getElementById('sugSupervisor').textContent = `Ù…Ù‚ØªØ±Ø­: ${s}`;
            document.getElementById('sugStaff').textContent = `Ù…Ù‚ØªØ±Ø­: ${st}`;
            document.getElementById('hoursAdjust').classList.remove('hidden');
        }

        function calculate() {
            const p = parseFloat(document.getElementById('adjPartner').value) || 0;
            const s = parseFloat(document.getElementById('adjSupervisor').value) || 0;
            const st = parseFloat(document.getElementById('adjStaff').value) || 0;
            const total = p + s + st;

            const monthly = ['rent','maintenance','utilities','software','adminSalaries','supplies']
                .reduce((sum, id) => sum + (parseFloat(document.getElementById(id)?.value) || 0), 0) * 12;
            const annual = ['insurance','depreciation','marketing','socpa','training']
                .reduce((sum, id) => sum + (parseFloat(document.getElementById(id)?.value) || 0), 0);
            const overhead = (monthly + annual) / (parseFloat(document.getElementById('annualHours')?.value) || 10000);

            const pr = parseFloat(document.getElementById('partnerRate')?.value) || 800;
            const sr = parseFloat(document.getElementById('supervisorRate')?.value) || 400;
            const str = parseFloat(document.getElementById('staffRate')?.value) || 150;
            const salaryCost = (p * pr) + (s * sr) + (st * str);
            const avgSalary = salaryCost / total;
            const costPerHour = avgSalary + overhead;
            const totalCost = total * costPerHour;
            const margin = parseFloat(document.getElementById('profitMargin')?.value) || 30;
            const priceBeforeVAT = totalCost * (1 + margin / 100);
            const totalPrice = priceBeforeVAT * 1.15; // Ù…Ø¹ Ø¶Ø±ÙŠØ¨Ø© 15%

            currentProposal = {
                totalHours: total,
                partnerHours: p,
                supervisorHours: s,
                staffHours: st,
                totalCost: totalCost,
                priceBeforeVAT: priceBeforeVAT,
                totalPrice: totalPrice,
                margin: margin
            };

            document.getElementById('totalHours').textContent = total.toFixed(1);
            document.getElementById('totalPrice').textContent = Math.round(totalPrice).toLocaleString() + ' Ø±ÙŠØ§Ù„';
            document.getElementById('totalCost').textContent = Math.round(totalCost).toLocaleString() + ' Ø±ÙŠØ§Ù„';
            document.getElementById('margin').textContent = margin + '%';
            document.getElementById('pricing').classList.remove('hidden');
        }

        function saveProposal() {
            const name = document.getElementById('clientName').value;
            if (!name) {
                alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„');
                return;
            }

            const client = {
                id: Date.now(),
                name,
                year: document.getElementById('year').value,
                revenue: parseFloat(document.getElementById('revenue').value) || 0,
                assets: parseFloat(document.getElementById('assets').value) || 0,
                fixedAssets: parseFloat(document.getElementById('fixedAssets').value) || 0,
                receivables: parseFloat(document.getElementById('receivables').value) || 0,
                payables: parseFloat(document.getElementById('payables').value) || 0,
                activity: document.getElementById('activity').value,
                partnerHours: currentProposal.partnerHours,
                supervisorHours: currentProposal.supervisorHours,
                staffHours: currentProposal.staffHours,
                totalHours: currentProposal.totalHours,
                price: currentProposal.totalPrice
            };

            clients.push(client);
            localStorage.setItem('clients', JSON.stringify(clients));
            alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©!');
        }

        function generateLetter() {
            const clientName = document.getElementById('clientName').value;
            const clientRep = document.getElementById('clientRep').value;
            const clientPosition = document.getElementById('clientPosition').value;
            const crNumber = document.getElementById('crNumber').value;
            const clientAddress = document.getElementById('clientAddress').value;
            const year = document.getElementById('year').value;
            const advancePercent = parseFloat(document.getElementById('advancePercent').value) || 50;

            if (!clientName || !clientRep || !crNumber) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Add Arabic font support
            doc.addFont('https://cdn.jsdelivr.net/npm/amiri-font@1.0.0/fonts/amiri-regular.ttf', 'Amiri', 'normal');
            doc.setFont('Amiri');
            doc.setR2L(true);

            const priceBeforeVAT = currentProposal.priceBeforeVAT || 0;
            const vat = priceBeforeVAT * 0.15;
            const totalPrice = priceBeforeVAT + vat;
            const advance = totalPrice * (advancePercent / 100);
            const remaining = totalPrice - advance;

            // Header
            doc.setFontSize(20);
            doc.text('Ø®Ø·Ø§Ø¨ Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·', 105, 30, { align: 'center' });
            
            doc.setFontSize(12);
            const today = new Date().toLocaleDateString('ar-SA');
            doc.text(today, 180, 50);

            // Client info
            doc.text(`Ø§Ù„Ø³Ø§Ø¯Ø© / ${clientName}`, 180, 70);
            doc.text(`Ø³Ø¬Ù„ ØªØ¬Ø§Ø±ÙŠ Ø±Ù‚Ù…: ${crNumber}`, 180, 80);
            doc.text(`${clientAddress}ØŒ Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©`, 180, 90);

            // Service description
            doc.text(`Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù„Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© ÙÙŠ 31 Ø¯ÙŠØ³Ù…Ø¨Ø± ${year}Ù…`, 180, 110);
            
            doc.setFontSize(10);
            doc.text('Ø³Ù†Ù‚ÙˆÙ…ØŒ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ÙƒÙ…ØŒ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø¨Ù…Ø§ ÙŠØ´Ù…Ù„:', 180, 130);
            doc.text('â€¢ Ø¨ÙŠØ§Ù† Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø§Ù„ÙŠ', 180, 140);
            doc.text('â€¢ Ø¨ÙŠØ§Ù† Ø§Ù„Ø±Ø¨Ø­ Ø£Ùˆ Ø§Ù„Ø®Ø³Ø§Ø±Ø© ÙˆØ§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ø§Ù…Ù„', 180, 150);
            doc.text('â€¢ Ø¨ÙŠØ§Ù† Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©', 180, 160);

            // Fees table
            doc.text('Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØªØ¹Ø§Ø¨ Ø§Ù„Ù…Ù‡Ù†ÙŠØ©:', 180, 180);
            doc.autoTable({
                startY: 190,
                head: [['Ø§Ù„Ø¨ÙŠØ§Ù†', 'Ø§Ù„Ù…Ø¨Ù„Øº']],
                body: [
                    ['Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)', `${priceBeforeVAT.toFixed(0)} Ø±ÙŠØ§Ù„`],
                    ['Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© 15%', `${vat.toFixed(0)} Ø±ÙŠØ§Ù„`],
                    ['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', `${totalPrice.toFixed(0)} Ø±ÙŠØ§Ù„`],
                    ['Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©', `${advance.toFixed(0)} Ø±ÙŠØ§Ù„ (${advancePercent}%)`],
                    ['Ø¹Ù†Ø¯ Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±', `${remaining.toFixed(0)} Ø±ÙŠØ§Ù„`]
                ],
                theme: 'grid',
                styles: { font: 'Amiri', halign: 'right' },
                headStyles: { fillColor: [200, 159, 101] }
            });

            // Signatures
            const finalY = doc.lastAutoTable.finalY + 30;
            doc.text('Ø´Ø±ÙƒØ© Ø¹Ù„ÙŠ ÙÙ‡Ø¯ Ù…Ø³Ø¹ÙˆØ¯', 140, finalY);
            doc.text(clientName, 40, finalY);
            doc.text('Ù…Ø­Ø§Ø³Ø¨ÙˆÙ† ÙˆÙ…Ø±Ø§Ø¬Ø¹ÙˆÙ† Ù‚Ø§Ù†ÙˆÙ†ÙŠÙˆÙ†', 140, finalY + 10);
            doc.text(`Ø§Ù„Ù…Ù…Ø«Ù„: ${clientRep}`, 40, finalY + 10);
            doc.text(`Ø§Ù„Ù…Ù†ØµØ¨: ${clientPosition}`, 40, finalY + 20);

            doc.save(`Ø®Ø·Ø§Ø¨_Ø§Ø±ØªØ¨Ø§Ø·_${clientName}_${year}.pdf`);
            closeModal('letterModal');
            alert('ØªÙ… Ø¥ØµØ¯Ø§Ø± Ø®Ø·Ø§Ø¨ Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ù†Ø¬Ø§Ø­!');
        }

        function loadCostsForm() {
            ['annualHours','rent','maintenance','utilities','software','adminSalaries','supplies',
             'insurance','depreciation','marketing','socpa','training',
             'partnerRate','supervisorRate','staffRate','profitMargin'].forEach(key => {
                const el = document.getElementById(key);
                if (el && costs[key]) el.value = costs[key];
            });
            calcCostSummary();
        }

        function saveCosts() {
            costs = {
                annualHours: parseFloat(document.getElementById('annualHours').value),
                rent: parseFloat(document.getElementById('rent').value) || 0,
                maintenance: parseFloat(document.getElementById('maintenance').value) || 0,
                utilities: parseFloat(document.getElementById('utilities').value) || 0,
                software: parseFloat(document.getElementById('software').value) || 0,
                adminSalaries: parseFloat(document.getElementById('adminSalaries').value) || 0,
                supplies: parseFloat(document.getElementById('supplies').value) || 0,
                insurance: parseFloat(document.getElementById('insurance').value) || 0,
                depreciation: parseFloat(document.getElementById('depreciation').value) || 0,
                marketing: parseFloat(document.getElementById('marketing').value) || 0,
                socpa: parseFloat(document.getElementById('socpa').value) || 0,
                training: parseFloat(document.getElementById('training').value) || 0,
                partnerRate: parseFloat(document.getElementById('partnerRate').value),
                supervisorRate: parseFloat(document.getElementById('supervisorRate').value),
                staffRate: parseFloat(document.getElementById('staffRate').value),
                profitMargin: parseFloat(document.getElementById('profitMargin').value)
            };
            localStorage.setItem('costs', JSON.stringify(costs));
            alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ');
            calcCostSummary();
        }

        function calcCostSummary() {
            const monthly = ['rent','maintenance','utilities','software','adminSalaries','supplies']
                .reduce((sum, id) => sum + (parseFloat(document.getElementById(id)?.value) || 0), 0) * 12;
            const annual = ['insurance','depreciation','marketing','socpa','training']
                .reduce((sum, id) => sum + (parseFloat(document.getElementById(id)?.value) || 0), 0);
            const total = monthly + annual;
            const hours = parseFloat(document.getElementById('annualHours')?.value) || 10000;
            const perHour = total / hours;

            if (document.getElementById('annualTotal'))
                document.getElementById('annualTotal').textContent = total.toLocaleString() + ' Ø±ÙŠØ§Ù„';
            if (document.getElementById('perHour'))
                document.getElementById('perHour').textContent = perHour.toFixed(2) + ' Ø±ÙŠØ§Ù„';
        }

        function loadPlanningForm() {
            // Copy current values to future fields
            document.getElementById('futureHours').value = costs.annualHours || 10000;
            document.getElementById('futureRent').value = costs.rent || 0;
            document.getElementById('futureMaintenance').value = costs.maintenance || 0;
            document.getElementById('futureUtilities').value = costs.utilities || 0;
            document.getElementById('futureAdmin').value = costs.adminSalaries || 0;
            document.getElementById('futureInsurance').value = costs.insurance || 0;
            document.getElementById('futureDepreciation').value = costs.depreciation || 0;
            document.getElementById('futureMarketing').value = costs.marketing || 0;
            document.getElementById('futureTraining').value = costs.training || 0;
            document.getElementById('futurePartnerRate').value = costs.partnerRate || 800;
            document.getElementById('futureSupervisorRate').value = costs.supervisorRate || 400;
            document.getElementById('futureStaffRate').value = costs.staffRate || 150;
        }

        function comparePlanning() {
            // Current scenario
            const currentMonthly = (costs.rent + costs.maintenance + costs.utilities + 
                                   costs.adminSalaries) * 12;
            const currentAnnual = costs.insurance + costs.depreciation + costs.marketing + costs.training;
            const currentTotal = currentMonthly + currentAnnual;
            const currentHours = costs.annualHours || 10000;
            const currentOverhead = currentTotal / currentHours;
            const currentAvgSalary = ((costs.partnerRate || 800) + (costs.supervisorRate || 400) + 
                                     (costs.staffRate || 150)) / 3;
            const currentFullCost = currentAvgSalary + currentOverhead;
            const currentPrice = currentFullCost * (1 + (costs.profitMargin || 30) / 100);

            // Future scenario
            const futureMonthly = (parseFloat(document.getElementById('futureRent').value) +
                                  parseFloat(document.getElementById('futureMaintenance').value) +
                                  parseFloat(document.getElementById('futureUtilities').value) +
                                  parseFloat(document.getElementById('futureAdmin').value)) * 12;
            const futureAnnual = parseFloat(document.getElementById('futureInsurance').value) +
                                parseFloat(document.getElementById('futureDepreciation').value) +
                                parseFloat(document.getElementById('futureMarketing').value) +
                                parseFloat(document.getElementById('futureTraining').value);
            const futureTotal = futureMonthly + futureAnnual;
            const futureHours = parseFloat(document.getElementById('futureHours').value) || 10000;
            const futureOverhead = futureTotal / futureHours;
            const futureAvgSalary = (parseFloat(document.getElementById('futurePartnerRate').value) +
                                    parseFloat(document.getElementById('futureSupervisorRate').value) +
                                    parseFloat(document.getElementById('futureStaffRate').value)) / 3;
            const futureFullCost = futureAvgSalary + futureOverhead;
            const futurePrice = futureFullCost * (1 + (costs.profitMargin || 30) / 100);

            // Calculate differences
            const costDiff = ((futureTotal - currentTotal) / currentTotal * 100).toFixed(1);
            const perHourDiff = ((futureOverhead - currentOverhead) / currentOverhead * 100).toFixed(1);
            const fullCostDiff = ((futureFullCost - currentFullCost) / currentFullCost * 100).toFixed(1);
            const priceDiff = ((futurePrice - currentPrice) / currentPrice * 100).toFixed(1);

            // Display comparison
            document.getElementById('currentAnnualCost').textContent = currentTotal.toLocaleString() + ' Ø±ÙŠØ§Ù„';
            document.getElementById('futureAnnualCost').textContent = futureTotal.toLocaleString() + ' Ø±ÙŠØ§Ù„';
            document.getElementById('costDiff').innerHTML = `<span class="${costDiff > 0 ? 'increase' : 'decrease'}">${costDiff}%</span>`;

            document.getElementById('currentPerHour').textContent = currentOverhead.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('futurePerHour').textContent = futureOverhead.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('perHourDiff').innerHTML = `<span class="${perHourDiff > 0 ? 'increase' : 'decrease'}">${perHourDiff}%</span>`;

            document.getElementById('currentFullCost').textContent = currentFullCost.toFixed(0) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('futureFullCost').textContent = futureFullCost.toFixed(0) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('fullCostDiff').innerHTML = `<span class="${fullCostDiff > 0 ? 'increase' : 'decrease'}">${fullCostDiff}%</span>`;

            document.getElementById('currentClientPrice').textContent = currentPrice.toFixed(0) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('futureClientPrice').textContent = futurePrice.toFixed(0) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('clientPriceDiff').innerHTML = `<span class="${priceDiff > 0 ? 'increase' : 'decrease'}">${priceDiff}%</span>`;

            // Recommendations
            let recommendations = '<ul style="padding-right: 20px;">';
            
            if (parseFloat(priceDiff) > 20) {
                recommendations += '<li>âš ï¸ Ø§Ù„Ø²ÙŠØ§Ø¯Ø© ÙÙŠ Ø§Ù„Ø³Ø¹Ø± Ø£ÙƒØ«Ø± Ù…Ù† 20% - Ù‚Ø¯ ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø¯Ø±Ø© Ø§Ù„ØªÙ†Ø§ÙØ³ÙŠØ©</li>';
                recommendations += '<li>ğŸ’¡ ÙÙƒØ± ÙÙŠ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ÙÙˆØªØ±Ø© Ù„ØªØ®ÙÙŠÙ Ø§Ù„ØªØ£Ø«ÙŠØ±</li>';
            } else if (parseFloat(priceDiff) > 10) {
                recommendations += '<li>âœ… Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ù…Ø¹Ù‚ÙˆÙ„Ø© ÙˆÙŠÙ…ÙƒÙ† ØªØ¨Ø±ÙŠØ±Ù‡Ø§ Ø¨Ø§Ù„ØªÙˆØ³Ø¹ ÙˆØ§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª</li>';
            } else {
                recommendations += '<li>âœ… Ø§Ù„ØªØ£Ø«ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ù…Ù†Ø®ÙØ¶ ÙˆÙ…Ù‚Ø¨ÙˆÙ„</li>';
            }

            const clientsNeeded = Math.ceil(futureTotal / futurePrice);
            recommendations += `<li>ğŸ“Š ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø­ÙˆØ§Ù„ÙŠ ${clientsNeeded} Ø¹Ù…ÙŠÙ„ Ø³Ù†ÙˆÙŠØ§Ù‹ Ù„ØªØºØ·ÙŠØ© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</li>`;

            const hoursNeeded = Math.ceil(futureTotal / futureFullCost);
            recommendations += `<li>â±ï¸ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ${hoursNeeded} Ø³Ø§Ø¹Ø© Ø¹Ù…Ù„ Ù…Ø¨Ø§Ø´Ø± Ø³Ù†ÙˆÙŠØ§Ù‹ Ù„ØªØ­Ù‚ÙŠÙ‚ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ¹Ø§Ø¯Ù„</li>`;

            if (futureHours > currentHours) {
                const increasePercent = ((futureHours - currentHours) / currentHours * 100).toFixed(0);
                recommendations += `<li>ğŸ“ˆ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ø¨Ù†Ø³Ø¨Ø© ${increasePercent}% - Ù…Ù…ØªØ§Ø² Ù„Ù„Ù†Ù…Ùˆ!</li>`;
            }

            recommendations += '</ul>';
            document.getElementById('recommendations').innerHTML = recommendations;

            document.getElementById('planningResult').classList.remove('hidden');
        }

        function loadClients() {
            if (clients.length === 0) {
                document.getElementById('clientsList').innerHTML = '<p style="text-align:center;color:var(--primary)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
                return;
            }
            let html = '<table><thead><tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ø³Ù†Ø©</th><th>Ø§Ù„Ù†Ø´Ø§Ø·</th><th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</th><th>Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th><th>Ø§Ù„Ø³Ø¹Ø±</th></tr></thead><tbody>';
            clients.forEach(c => {
                html += `<tr><td>${c.name}</td><td>${c.year}</td><td>${c.activity}</td><td>${c.revenue}</td><td>${c.totalHours}</td><td>${c.price.toLocaleString()}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('clientsList').innerHTML = html;
        }

        // Load costs on page load
        if (Object.keys(costs).length > 0) {
            loadCostsForm();
        }
    </script>
</body>
</html>
